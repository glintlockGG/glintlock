<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Glintlock — Campaign Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=DM+Sans:wght@400;500;600&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    /* Surfaces */
    --bg-app:        #0f1117;
    --bg-rail:       #13151c;
    --bg-surface:    #181b24;
    --bg-card:       #1e2130;
    --bg-card-hover: #252839;
    --bg-input:      #12141b;

    /* Borders */
    --border:       #2a2d3a;
    --border-light: #3a3e50;

    /* Text */
    --text:          #e8e4dc;
    --text-secondary:#b8b4aa;
    --text-dim:      #6b6860;
    --text-label:    #8a8680;

    /* Accent — torchlight amber */
    --amber:     #e8a44a;
    --amber-dim: rgba(232,164,74,0.15);
    --amber-glow:rgba(232,164,74,0.08);

    /* Status */
    --red:      #e85454;
    --red-dim:  rgba(232,84,84,0.15);
    --green:    #4abe7a;
    --green-dim:rgba(74,190,122,0.15);
    --blue:     #5b8def;
    --blue-dim: rgba(91,141,239,0.12);
    --violet:   #a78bfa;
    --violet-dim:rgba(167,139,250,0.12);
    --warning:  #eab308;
    --warning-dim:rgba(234,179,8,0.12);

    /* Stat accent colors */
    --stat-vigor:    #d4622a;
    --stat-reflex:   #2dd4bf;
    --stat-wits:     #eab308;
    --stat-resolve:  #a78bfa;
    --stat-presence: #f472b6;
    --stat-lore:     #5865F2;

    /* Layout */
    --rail-width:   64px;
    --bottom-height:52px;
    --right-width:  320px;

    /* Typography */
    --font-display:   'Cinzel', serif;
    --font-body:      'DM Sans', system-ui, sans-serif;
    --font-narrative: 'Crimson Pro', serif;
    --font-mono:      'JetBrains Mono', monospace;

    /* Radius */
    --radius:    8px;
    --radius-sm: 6px;
    --radius-lg: 10px;
    --radius-pill: 20px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    height: 100%;
    overflow: hidden;
    background: var(--bg-app);
    color: var(--text);
    font-family: var(--font-body);
    font-size: 13px;
    line-height: 1.5;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    opacity: 0.018;
    pointer-events: none;
    z-index: 9999;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    background-repeat: repeat;
    background-size: 256px 256px;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* ================= APP SHELL ================= */
  .app-shell {
    display: grid;
    grid-template-columns: var(--rail-width) 1fr var(--right-width);
    grid-template-rows: 1fr var(--bottom-height);
    height: 100vh;
    width: 100vw;
  }

  .app-shell.right-collapsed {
    grid-template-columns: var(--rail-width) 1fr 0px;
  }

  .app-shell.right-collapsed .right-drawer { display: none; }

  /* ================= LEFT RAIL ================= */
  .left-rail {
    grid-column: 1;
    grid-row: 1 / -1;
    background: var(--bg-rail);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 0;
    gap: 4px;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .rail-logo {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: var(--amber-dim);
    border: 1px solid var(--amber);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    margin-bottom: 8px;
    cursor: pointer;
    color: var(--amber);
    font-weight: 700;
    font-family: var(--font-display);
  }

  .rail-divider {
    width: 28px;
    height: 1px;
    background: var(--border);
    margin: 6px 0;
  }

  .rail-btn {
    width: 40px;
    height: 40px;
    border-radius: var(--radius);
    background: transparent;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    position: relative;
    font-size: 16px;
  }

  .rail-btn:hover {
    background: var(--bg-card);
    color: var(--text-secondary);
  }

  .rail-btn.active {
    background: var(--amber-dim);
    color: var(--amber);
  }

  .rail-btn .tooltip {
    display: none;
    position: absolute;
    left: calc(100% + 8px);
    top: 50%;
    transform: translateY(-50%);
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    color: var(--text);
    z-index: 100;
    pointer-events: none;
  }

  .rail-btn:hover .tooltip { display: block; }

  .rail-spacer { flex: 1; }

  /* Rail minicard */
  .rail-minicard {
    width: 48px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    padding: 6px 0;
    margin-top: auto;
  }

  .minicard-hp {
    width: 36px;
    height: 4px;
    background: var(--bg-card);
    border-radius: 2px;
    overflow: hidden;
  }

  .minicard-hp-fill {
    height: 100%;
    background: var(--green);
    border-radius: 2px;
    transition: width 0.3s;
  }

  .minicard-hp-fill.wounded { background: var(--amber); }
  .minicard-hp-fill.critical { background: var(--red); }

  .minicard-label {
    font-size: 9px;
    color: var(--text-dim);
    text-align: center;
    line-height: 1.2;
    font-family: var(--font-mono);
  }

  /* ================= CENTER WORKSPACE ================= */
  .center-workspace {
    grid-column: 2;
    grid-row: 1;
    background: var(--bg-app);
    overflow: hidden;
    position: relative;
  }

  .view {
    display: none;
    position: absolute;
    inset: 0;
    overflow-y: auto;
    padding: 20px 24px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .view::-webkit-scrollbar { width: 6px; }
  .view::-webkit-scrollbar-track { background: transparent; }
  .view::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .view.active { display: block; }

  /* View header */
  .view-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .view-title {
    font-family: var(--font-display);
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    letter-spacing: 0.02em;
  }

  .view-subtitle {
    font-size: 11px;
    color: var(--text-dim);
    margin-left: 12px;
  }

  /* ================= CARDS ================= */
  .card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    margin-bottom: 12px;
    overflow: hidden;
  }

  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
  }

  .card-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-label);
    font-weight: 600;
  }

  .card-badge {
    font-family: var(--font-mono);
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 4px;
    background: var(--bg-card);
    color: var(--text-dim);
  }

  .card-body {
    padding: 12px 16px;
  }

  /* ================= PILLS & BADGES ================= */
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 1px 8px;
    border-radius: var(--radius-pill);
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    white-space: nowrap;
  }

  .pill-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .pill-alive { background: var(--green-dim); color: var(--green); }
  .pill-alive .pill-dot { background: var(--green); }
  .pill-deceased { background: var(--red-dim); color: var(--red); }
  .pill-deceased .pill-dot { background: var(--red); }
  .pill-friendly { background: var(--green-dim); color: var(--green); }
  .pill-wary { background: var(--warning-dim); color: var(--warning); }
  .pill-hostile { background: var(--red-dim); color: var(--red); }
  .pill-neutral { background: rgba(107,104,96,0.12); color: var(--text-dim); }
  .pill-active { background: var(--green-dim); color: var(--green); }
  .pill-developing { background: var(--blue-dim); color: var(--blue); }
  .pill-completed { background: rgba(107,104,96,0.12); color: var(--text-dim); }

  /* Journal tag pills */
  .tag {
    display: inline-block;
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 1px 5px;
    border-radius: 3px;
    white-space: nowrap;
  }

  .tag-event       { background: var(--amber-dim); color: var(--amber); }
  .tag-discovery   { background: var(--green-dim); color: var(--green); }
  .tag-thread      { background: var(--blue-dim); color: var(--blue); }
  .tag-ruling      { background: var(--violet-dim); color: var(--violet); }
  .tag-world-advance { background: var(--red-dim); color: var(--red); }

  /* Sub-tabs within cards */
  .sub-tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .sub-tab {
    padding: 8px 14px;
    font-family: var(--font-body);
    font-size: 11px;
    font-weight: 500;
    color: var(--text-dim);
    cursor: pointer;
    border: none;
    background: none;
    position: relative;
    transition: color 0.15s;
  }

  .sub-tab:hover { color: var(--text-secondary); }

  .sub-tab.active { color: var(--amber); }

  .sub-tab.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 14px;
    right: 14px;
    height: 2px;
    background: var(--amber);
    border-radius: 2px 2px 0 0;
  }

  .sub-pane { display: none; }
  .sub-pane.active { display: block; }

  /* Danger badge */
  .danger-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-weight: 600;
    font-family: var(--font-mono);
  }

  .danger-safe   { background: var(--green-dim); color: var(--green); }
  .danger-unsafe { background: var(--amber-dim); color: var(--amber); }
  .danger-risky  { background: var(--red-dim); color: var(--red); }
  .danger-deadly { background: var(--red-dim); color: var(--red); }

  /* No-content fallback */
  .no-content {
    text-align: center;
    color: var(--text-dim);
    font-style: italic;
    font-family: var(--font-narrative);
    font-size: 14px;
    padding: 40px 0;
  }

  /* Two-column layout helper */
  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  /* ================= PLAYER VIEW ================= */
  .char-hero {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 16px;
    align-items: center;
    padding: 16px 20px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
  }

  .char-avatar {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    background: var(--bg-card);
    border: 2px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .char-identity h2 {
    font-family: var(--font-display);
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.2;
  }

  .char-identity .char-meta {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  .char-vitals {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .vital-block {
    text-align: center;
    padding: 6px 12px;
    background: var(--bg-card);
    border-radius: var(--radius);
    min-width: 56px;
  }

  .vital-value {
    font-family: var(--font-mono);
    font-size: 18px;
    font-weight: 500;
    color: var(--text);
  }

  .vital-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
    margin-top: 1px;
  }

  /* HP Bar */
  .hp-bar-container {
    padding: 12px 20px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
  }

  .hp-bar-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
  }

  .hp-bar-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.06em; }
  .hp-bar-value { font-family: var(--font-mono); font-size: 12px; color: var(--text-secondary); }

  .hp-bar {
    height: 8px;
    background: var(--bg-card);
    border-radius: 4px;
    overflow: hidden;
  }

  .hp-bar-fill {
    height: 100%;
    border-radius: 4px;
    background: var(--green);
    transition: width 0.4s ease;
  }

  .hp-bar-fill.wounded { background: var(--amber); }
  .hp-bar-fill.critical { background: var(--red); }

  /* Stats grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    margin-bottom: 16px;
  }

  .stat-cell {
    text-align: center;
    padding: 10px 6px 8px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    position: relative;
    overflow: hidden;
  }

  .stat-cell::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--stat-color, var(--border));
  }

  .stat-value {
    font-family: var(--font-mono);
    font-size: 20px;
    font-weight: 500;
    color: var(--text);
    line-height: 1;
  }

  .stat-name {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
    margin-top: 4px;
  }

  .stat-dc {
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  .stat-trained {
    font-size: 9px;
    color: var(--amber);
    margin-top: 2px;
    line-height: 1.3;
    word-break: break-word;
  }

  /* Training pills */
  .training-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .training-pill {
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 12px;
    background: var(--amber-dim);
    color: var(--amber);
    border: 1px solid rgba(232,164,74,0.2);
  }

  /* Countdown dice */
  .countdown-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
  }

  .countdown-row:last-child { border-bottom: none; }
  .countdown-name { color: var(--text-secondary); }

  .countdown-die {
    font-family: var(--font-mono);
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 4px;
    background: var(--bg-card);
    color: var(--text);
  }

  .countdown-die.low { color: var(--red); background: var(--red-dim); }

  /* Inventory */
  .inventory-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
  }

  .inventory-item:last-child { border-bottom: none; }

  .inventory-item-name {
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .inventory-item-detail {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-dim);
  }

  /* Death clock */
  .death-clock {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .death-clock-pips {
    display: flex;
    gap: 3px;
  }

  .death-pip {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 1px solid var(--red);
  }

  .death-pip.filled { background: var(--red); }

  .death-clock-label {
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--red);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Feature & spell items */
  .feature-item {
    font-size: 12px;
    color: var(--text-secondary);
    padding: 3px 0;
    line-height: 1.5;
  }

  .spell-item {
    font-size: 12px;
    color: var(--text-secondary);
    padding: 3px 0;
  }

  .spell-item::before {
    content: '\2022';
    color: var(--amber);
    margin-right: 6px;
  }

  /* Location */
  .loc-desc {
    font-family: var(--font-narrative);
    font-size: 13px;
    font-style: italic;
    color: var(--text-secondary);
    line-height: 1.6;
    margin-top: 6px;
  }

  /* ================= GM VIEW ================= */
  .gm-section {
    margin-bottom: 4px;
  }

  .secret-item {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
  }

  .secret-item:last-child { border-bottom: none; }

  .secret-label {
    font-weight: 600;
    color: var(--text);
    margin-bottom: 2px;
  }

  .secret-info {
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .secret-discovery {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
  }

  /* NPC combat grid */
  .npc-combat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 8px;
  }

  .npc-combat-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px 12px;
  }

  .npc-combat-name {
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 6px;
  }

  .npc-stat-row {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-dim);
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .npc-stat-row .val { color: var(--text); }

  .dc-reference {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-dim);
    line-height: 1.8;
  }

  /* Doom portent pips */
  .doom-track {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }

  .doom-track:last-child { border-bottom: none; }

  .doom-name {
    font-size: 12px;
    font-weight: 500;
    color: var(--text);
    min-width: 120px;
  }

  .doom-pips {
    display: flex;
    gap: 4px;
  }

  .doom-pip {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 1.5px solid var(--border-light);
  }

  .doom-pip.filled { background: var(--red); border-color: var(--red); }

  .doom-portent-label {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    min-width: 40px;
    text-align: right;
  }

  /* Progress clock */
  .clock-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .clock-svg { flex-shrink: 0; }

  .clock-label {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .clock-meta {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
  }

  /* ================= CAMPAIGN VIEW ================= */
  .campaign-banner {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 16px 20px;
    margin-bottom: 16px;
  }

  .campaign-title {
    font-family: var(--font-display);
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: 0.04em;
    margin-bottom: 2px;
  }

  .campaign-subtitle {
    font-family: var(--font-narrative);
    font-size: 13px;
    font-style: italic;
    color: var(--text-dim);
    margin-bottom: 4px;
  }

  .campaign-meta {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-dim);
  }

  /* Calendar card */
  .calendar-date {
    font-family: var(--font-display);
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
  }

  .calendar-detail {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.6;
  }

  /* World state */
  .world-state-text {
    font-family: var(--font-narrative);
    font-size: 13px;
    font-style: italic;
    color: var(--text-secondary);
    line-height: 1.7;
  }

  /* Faction cards */
  .faction-card {
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }

  .faction-card:last-child { border-bottom: none; }

  .faction-name {
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 2px;
  }

  .faction-goals {
    font-size: 11px;
    color: var(--text-secondary);
    font-style: italic;
    margin-top: 4px;
  }

  /* Quest cards */
  .quest-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 8px 12px;
    margin-bottom: 6px;
    border-left: 3px solid var(--green);
  }

  .quest-card.developing { border-left-color: var(--blue); }
  .quest-card.completed { border-left-color: var(--text-dim); }

  .quest-name {
    font-weight: 500;
    font-size: 12px;
    color: var(--text);
  }

  .quest-desc {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 2px;
    line-height: 1.5;
  }

  /* Timeline */
  .timeline-session { margin-bottom: 12px; }

  .timeline-label {
    font-family: var(--font-display);
    font-size: 11px;
    font-weight: 600;
    color: var(--text);
    letter-spacing: 0.04em;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 4px;
  }

  .timeline-entry {
    font-size: 11px;
    color: var(--text-secondary);
    padding: 2px 0 2px 12px;
    border-left: 1px solid var(--border);
    margin-left: 4px;
  }

  /* ================= MEDIA VIEW ================= */
  .media-layout {
    display: grid;
    grid-template-columns: 240px 1fr;
    grid-template-rows: 1fr auto;
    gap: 0;
    position: absolute;
    inset: 0;
  }

  .media-list {
    grid-column: 1;
    grid-row: 1;
    background: var(--bg-surface);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 8px 0;
  }

  .chapter-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    font-size: 12px;
    color: var(--text-dim);
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-family: var(--font-body);
    transition: color 0.15s, background 0.15s;
  }

  .chapter-item:hover {
    color: var(--text-secondary);
    background: var(--bg-card);
  }

  .chapter-item.active {
    color: var(--text);
    background: var(--bg-card);
  }

  .ch-num {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    flex-shrink: 0;
  }

  .ch-title {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .ch-status {
    font-size: 9px;
    padding: 1px 6px;
    border-radius: 3px;
    font-weight: 600;
    flex-shrink: 0;
  }

  .ch-status-read { background: var(--green-dim); color: var(--green); }
  .ch-status-audio { background: var(--blue-dim); color: var(--blue); }

  .media-player {
    grid-column: 1;
    grid-row: 2;
    background: var(--bg-surface);
    border-right: 1px solid var(--border);
    border-top: 1px solid var(--border);
    padding: 10px 14px;
  }

  .player-title {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .media-player audio {
    width: 100%;
    height: 32px;
    border-radius: var(--radius-sm);
    outline: none;
  }

  audio::-webkit-media-controls-panel { background: var(--bg-rail); }
  audio::-webkit-media-controls-current-time-display,
  audio::-webkit-media-controls-time-remaining-display {
    color: var(--text-dim);
    font-size: 10px;
  }

  .media-reader {
    grid-column: 2;
    grid-row: 1 / 3;
    overflow-y: auto;
    padding: 40px 48px;
  }

  .chapter-prose {
    max-width: 640px;
    margin: 0 auto;
    font-family: var(--font-narrative);
    font-size: 16px;
    font-weight: 300;
    line-height: 1.75;
    color: var(--text-secondary);
  }

  .chapter-prose h1 {
    font-family: var(--font-display);
    font-size: 22px;
    font-weight: 600;
    color: var(--amber);
    margin-bottom: 8px;
    letter-spacing: 0.04em;
  }

  .chapter-prose hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 28px auto;
    width: 40%;
  }

  .chapter-prose p {
    margin-bottom: 16px;
    text-indent: 1.5em;
  }

  .chapter-prose p:first-of-type,
  .chapter-prose hr + p { text-indent: 0; }

  .chapter-prose em { color: var(--text-dim); }

  .chapter-prose .epigraph {
    text-align: center;
    font-style: italic;
    color: var(--text-dim);
    margin: 24px 0;
    text-indent: 0;
  }

  /* ================= ANALYTICS VIEW ================= */
  .analytics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }

  .analytics-stat {
    text-align: center;
    padding: 16px 8px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
  }

  .analytics-value {
    font-family: var(--font-mono);
    font-size: 28px;
    font-weight: 500;
    color: var(--text);
    line-height: 1;
  }

  .analytics-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
    margin-top: 6px;
  }

  .chart-placeholder {
    font-size: 12px;
    color: var(--text-dim);
    text-align: center;
    padding: 40px;
    font-style: italic;
  }

  /* ================= RIGHT DRAWER ================= */
  .right-drawer {
    grid-column: 3;
    grid-row: 1 / -1;
    background: var(--bg-surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .drawer-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .drawer-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .drawer-close {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }

  .drawer-close:hover { background: var(--bg-card); color: var(--text-secondary); }

  .drawer-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .drawer-tab {
    flex: 1;
    padding: 8px;
    text-align: center;
    font-size: 11px;
    color: var(--text-dim);
    background: transparent;
    border: none;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }

  .drawer-tab:hover { color: var(--text-secondary); }
  .drawer-tab.active { color: var(--amber); border-bottom-color: var(--amber); }

  .drawer-body {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .drawer-content { display: none; }
  .drawer-content.active { display: block; }

  /* Drawer quest items */
  .dq-item {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }

  .dq-item:last-child { border-bottom: none; }

  .dq-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 2px;
  }

  .dq-name {
    font-size: 12px;
    font-weight: 500;
    color: var(--text);
  }

  .dq-desc {
    font-size: 11px;
    color: var(--text-dim);
    line-height: 1.5;
  }

  /* Drawer NPC items */
  .dn-item {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }

  .dn-item:last-child { border-bottom: none; }

  .dn-name {
    font-size: 12px;
    font-weight: 500;
    color: var(--text);
  }

  .dn-meta {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  .dn-disposition {
    display: inline-block;
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 3px;
    margin-top: 4px;
  }

  .dn-disposition.friendly { background: var(--green-dim); color: var(--green); }
  .dn-disposition.neutral  { background: var(--blue-dim); color: var(--blue); }
  .dn-disposition.wary     { background: var(--warning-dim); color: var(--warning); }
  .dn-disposition.hostile  { background: var(--red-dim); color: var(--red); }

  /* Drawer log entries */
  .dl-entry {
    display: flex;
    gap: 8px;
    padding: 5px 0;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
  }

  .dl-entry:last-child { border-bottom: none; }

  .dl-text { color: var(--text-secondary); line-height: 1.5; }

  /* ================= BOTTOM BAR ================= */
  .bottom-bar {
    grid-column: 2 / -1;
    background: var(--bg-rail);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 20px;
    font-size: 11px;
    overflow-x: auto;
    scrollbar-width: none;
  }

  .bottom-bar::-webkit-scrollbar { display: none; }

  .bar-section {
    display: flex;
    align-items: center;
    gap: 10px;
    white-space: nowrap;
  }

  .bar-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
  }

  .bar-divider {
    width: 1px;
    height: 24px;
    background: var(--border);
    flex-shrink: 0;
  }

  .bar-countdown {
    display: flex;
    align-items: center;
    gap: 4px;
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-secondary);
  }

  .bar-countdown-icon { font-size: 12px; }
  .bar-countdown.low { color: var(--red); }

  .bar-clock {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .clock-segments {
    display: flex;
    gap: 2px;
  }

  .clock-seg {
    width: 8px;
    height: 8px;
    border-radius: 2px;
    border: 1px solid var(--border-light);
    background: transparent;
  }

  .clock-seg.filled { background: var(--amber); border-color: var(--amber); }

  .bar-clock-label {
    font-size: 10px;
    color: var(--text-dim);
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .bar-doom {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .bar-doom-pips {
    display: flex;
    gap: 2px;
  }

  .bar-doom-pip {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    border: 1px solid var(--border-light);
  }

  .bar-doom-pip.filled { background: var(--red); border-color: var(--red); }

  .bar-doom-label {
    font-size: 10px;
    color: var(--text-dim);
  }

  .bar-calendar {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text-secondary);
    font-size: 11px;
  }

  .bar-calendar-icon { font-size: 13px; }

  .bar-right {
    margin-left: auto;
    flex-shrink: 0;
  }

  /* ================= RESPONSIVE ================= */
  @media (max-width: 1200px) {
    .app-shell {
      grid-template-columns: var(--rail-width) 1fr 0px;
    }
    .right-drawer { display: none; }
  }

  @media (max-width: 900px) {
    .app-shell {
      grid-template-columns: 1fr;
      grid-template-rows: 48px 1fr var(--bottom-height);
    }

    .left-rail {
      grid-row: 1;
      flex-direction: row;
      padding: 0 8px;
      gap: 2px;
      border-right: none;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      overflow-y: hidden;
    }

    .rail-logo { margin-bottom: 0; margin-right: 8px; width: 32px; height: 32px; }
    .rail-divider { width: 1px; height: 24px; margin: 0 4px; }
    .rail-spacer { display: none; }
    .rail-minicard { display: none; }
    .rail-btn .tooltip { display: none !important; }

    .center-workspace { grid-row: 2; }
    .right-drawer { display: none; }

    .bottom-bar {
      grid-column: 1;
      padding: 0 12px;
      gap: 12px;
    }

    .stats-grid { grid-template-columns: repeat(3, 1fr); }
    .two-col { grid-template-columns: 1fr; }
    .analytics-grid { grid-template-columns: repeat(2, 1fr); }

    .media-layout {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr auto;
    }

    .media-list {
      grid-column: 1;
      grid-row: 1;
      max-height: 120px;
      border-right: none;
      border-bottom: 1px solid var(--border);
    }

    .media-reader { grid-column: 1; grid-row: 2; padding: 20px 16px; }
    .media-player { grid-column: 1; grid-row: 3; border-right: none; }
  }

  @media (max-width: 600px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .char-hero { grid-template-columns: 1fr; }
    .char-avatar { display: none; }
    .char-vitals { flex-wrap: wrap; gap: 8px; }
    .media-reader { padding: 16px 12px; }
    .chapter-prose { font-size: 14px; }
  }
</style>
</head>
<body>

<div class="app-shell" id="appShell">

  <!-- LEFT RAIL -->
  <nav class="left-rail">
    <div class="rail-logo" onclick="switchView('player')">G</div>
    <div class="rail-divider"></div>

    <button class="rail-btn active" data-view="player" onclick="switchView('player')">
      &#9876;<span class="tooltip">Player</span>
    </button>
    <button class="rail-btn" data-view="gm" onclick="switchView('gm')">
      &#9881;<span class="tooltip">GM Screen</span>
    </button>
    <button class="rail-btn" data-view="campaign" onclick="switchView('campaign')">
      &#9734;<span class="tooltip">Campaign</span>
    </button>
    <button class="rail-btn" data-view="media" onclick="switchView('media')">
      &#9836;<span class="tooltip">Media</span>
    </button>
    <button class="rail-btn" data-view="analytics" onclick="switchView('analytics')">
      &#9783;<span class="tooltip">Analytics</span>
    </button>

    <div class="rail-divider"></div>

    <button class="rail-btn" onclick="toggleDrawer()">
      &#9776;<span class="tooltip">Toggle Drawer</span>
    </button>

    <div class="rail-spacer"></div>

    <div class="rail-minicard" id="rail-minicard"></div>
  </nav>

  <!-- CENTER WORKSPACE -->
  <main class="center-workspace">
    <div class="view active" id="view-player"></div>
    <div class="view" id="view-gm"></div>
    <div class="view" id="view-campaign"></div>
    <div class="view" id="view-media"></div>
    <div class="view" id="view-analytics"></div>
  </main>

  <!-- RIGHT DRAWER -->
  <aside class="right-drawer" id="rightDrawer">
    <div class="drawer-header">
      <span class="drawer-title">Context</span>
      <button class="drawer-close" onclick="toggleDrawer()">&#10005;</button>
    </div>
    <div class="drawer-tabs">
      <button class="drawer-tab active" onclick="switchDrawerTab(this,'quests')">Quests</button>
      <button class="drawer-tab" onclick="switchDrawerTab(this,'npcs')">NPCs</button>
      <button class="drawer-tab" onclick="switchDrawerTab(this,'log')">Log</button>
    </div>
    <div class="drawer-body">
      <div class="drawer-content active" id="drawer-quests"></div>
      <div class="drawer-content" id="drawer-npcs"></div>
      <div class="drawer-content" id="drawer-log"></div>
    </div>
  </aside>

  <!-- BOTTOM BAR -->
  <footer class="bottom-bar" id="bottom-bar"></footer>

</div>

<script>
const DATA = DASHBOARD_DATA;

/* ==================== Utilities ==================== */
function esc(s) {
  if (s == null) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

function difficulty(stat, trained) {
  return trained ? Math.max(1, 20 - stat * 2) : Math.max(1, 20 - stat);
}

function hpState(cur, max) {
  const pct = cur / Math.max(max, 1);
  if (pct > 0.5) return 'healthy';
  if (pct > 0.25) return 'wounded';
  return 'critical';
}

function hpBarHtml(cur, max) {
  const pct = Math.max(0, Math.min(100, (cur / Math.max(max, 1)) * 100));
  const state = hpState(cur, max);
  const cls = state === 'critical' ? ' critical' : (state === 'wounded' ? ' wounded' : '');
  return '<div class="hp-bar-container">' +
    '<div class="hp-bar-header"><span class="hp-bar-label">Hit Points</span>' +
    '<span class="hp-bar-value">' + cur + ' / ' + max + '</span></div>' +
    '<div class="hp-bar"><div class="hp-bar-fill' + cls + '" style="width:' + pct + '%"></div></div></div>';
}

function pillBadge(text, cls) {
  const hasDot = cls.indexOf('pill-alive') >= 0 || cls.indexOf('pill-deceased') >= 0;
  return '<span class="pill ' + cls + '">' + (hasDot ? '<span class="pill-dot"></span>' : '') + esc(text) + '</span>';
}

function dispositionPill(d) {
  const map = { friendly: 'pill-friendly', wary: 'pill-wary', hostile: 'pill-hostile', neutral: 'pill-neutral' };
  return pillBadge(d, map[(d || '').toLowerCase()] || 'pill-neutral');
}

function tagSpan(tag) {
  const tc = { event: 'tag-event', discovery: 'tag-discovery', ruling: 'tag-ruling', thread: 'tag-thread', 'world-advance': 'tag-world-advance' };
  return '<span class="tag ' + (tc[tag] || 'tag-event') + '">' + tag + '</span>';
}

function dangerBadge(level) {
  const l = (level || 'safe').toLowerCase();
  const cls = l === 'deadly' ? 'danger-deadly' : (l === 'risky' ? 'danger-risky' : (l === 'unsafe' ? 'danger-unsafe' : 'danger-safe'));
  return '<span class="danger-badge ' + cls + '">' + esc(level || 'Safe') + '</span>';
}

function md2html(text) {
  if (!text) return '';
  let html = text.replace(/\n---\n/g, '<hr>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  html = html.replace(/^\*([^*]+)\*$/gm, '<p class="epigraph"><em>$1</em></p>');
  html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
  const parts = html.split(/\n\n+/);
  return parts.map(function(p) {
    p = p.trim();
    if (!p) return '';
    if (p.startsWith('<h1>') || p.startsWith('<hr') || p.startsWith('<p class="epigraph">')) return p;
    return '<p>' + p + '</p>';
  }).join('\n');
}

function doomPipsHtml(level, total) {
  total = total || 6;
  let html = '<div class="doom-pips">';
  for (var i = 0; i < total; i++) {
    html += '<div class="doom-pip' + (i < level ? ' filled' : '') + '"></div>';
  }
  html += '</div>';
  return html;
}

function clockSegmentsHtml(filled, total) {
  let html = '<div class="clock-segments">';
  for (var i = 0; i < total; i++) {
    html += '<div class="clock-seg' + (i < filled ? ' filled' : '') + '"></div>';
  }
  html += '</div>';
  return html;
}

function clockSvg(filled, total, size) {
  size = size || 32;
  var r = size / 2 - 2;
  var cx = size / 2;
  var cy = size / 2;
  var svg = '<svg class="clock-svg" width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '">';
  svg += '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="var(--bg-card)" stroke="var(--border)" stroke-width="1.5"/>';
  for (var i = 0; i < total; i++) {
    var startAngle = (i / total) * 2 * Math.PI - Math.PI / 2;
    var endAngle = ((i + 1) / total) * 2 * Math.PI - Math.PI / 2;
    var x1 = cx + r * Math.cos(startAngle);
    var y1 = cy + r * Math.sin(startAngle);
    var x2 = cx + r * Math.cos(endAngle);
    var y2 = cy + r * Math.sin(endAngle);
    var largeArc = (endAngle - startAngle > Math.PI) ? 1 : 0;
    if (i < filled) {
      svg += '<path d="M' + cx + ',' + cy + ' L' + x1 + ',' + y1 + ' A' + r + ',' + r + ' 0 ' + largeArc + ',1 ' + x2 + ',' + y2 + ' Z" fill="var(--amber)" opacity="0.85"/>';
    }
    svg += '<line x1="' + cx + '" y1="' + cy + '" x2="' + x1 + '" y2="' + y1 + '" stroke="var(--border)" stroke-width="1"/>';
  }
  svg += '</svg>';
  return svg;
}

function parseJournal(journal) {
  var groups = [];
  var current = { label: 'Journal', entries: [] };
  (journal || []).forEach(function(e) {
    var str = typeof e === 'string' ? e : '';
    var m = str.match(/^##?\s*Session\s+(\d+)/);
    if (m) {
      if (current.entries.length) groups.push(current);
      current = { label: 'Session ' + m[1], entries: [] };
      return;
    }
    if (str.trim() && !str.match(/^#/)) current.entries.push(str);
  });
  if (current.entries.length) groups.push(current);
  return groups;
}

/* Stat mapping */
var SKILL_STAT_MAP = {
  'Athletics': 'vigor', 'Endurance': 'vigor',
  'Acrobatics': 'reflex', 'Stealth': 'reflex', 'Sleight': 'reflex',
  'Awareness': 'wits', 'Survival': 'wits', 'Tinker': 'wits',
  'Fortitude': 'resolve', 'Commune': 'resolve',
  'Persuasion': 'presence', 'Deception': 'presence',
  'Arcana': 'lore', 'Medicine': 'lore', 'History': 'lore'
};

var STAT_COLORS = {
  vigor: 'var(--stat-vigor)', reflex: 'var(--stat-reflex)', wits: 'var(--stat-wits)',
  resolve: 'var(--stat-resolve)', presence: 'var(--stat-presence)', lore: 'var(--stat-lore)'
};

/* ==================== Layout Functions ==================== */
var viewTitles = { player: 'Character Sheet', gm: 'GM Screen', campaign: 'Campaign Overview', media: 'Story & Audio', analytics: 'Analytics' };

function switchView(name) {
  document.querySelectorAll('.view').forEach(function(v) { v.classList.remove('active'); });
  var target = document.getElementById('view-' + name);
  if (target) target.classList.add('active');
  document.querySelectorAll('.rail-btn[data-view]').forEach(function(b) { b.classList.remove('active'); });
  var btn = document.querySelector('.rail-btn[data-view="' + name + '"]');
  if (btn) btn.classList.add('active');
}

function toggleDrawer() {
  document.getElementById('appShell').classList.toggle('right-collapsed');
}

function switchDrawerTab(btn, tabName) {
  document.querySelectorAll('.drawer-tab').forEach(function(t) { t.classList.remove('active'); });
  btn.classList.add('active');
  document.querySelectorAll('.drawer-content').forEach(function(c) { c.classList.remove('active'); });
  var el = document.getElementById('drawer-' + tabName);
  if (el) el.classList.add('active');
}

function switchSubTab(groupId, tabName) {
  var group = document.getElementById(groupId);
  if (!group) return;
  group.querySelectorAll('.sub-tab').forEach(function(t) { t.classList.remove('active'); });
  group.querySelectorAll('.sub-pane').forEach(function(p) { p.classList.remove('active'); });
  var tab = group.querySelector('.sub-tab[data-tab="' + tabName + '"]');
  var pane = group.querySelector('.sub-pane[data-pane="' + tabName + '"]');
  if (tab) tab.classList.add('active');
  if (pane) pane.classList.add('active');
}

var currentChapter = 0;

function selectChapter(idx) {
  var chapters = DATA.chapters || [];
  var ch = chapters[idx];
  if (!ch) return;
  currentChapter = idx;
  document.querySelectorAll('.chapter-item').forEach(function(ci) { ci.classList.remove('active'); });
  var btn = document.querySelector('.chapter-item[data-idx="' + idx + '"]');
  if (btn) btn.classList.add('active');
  document.getElementById('chapter-content').innerHTML = md2html(ch.content);
  var audiobooks = DATA.audiobooks || [];
  var audioMap = {};
  audiobooks.forEach(function(ab) { audioMap[ab.chapter] = ab; });
  var audio = audioMap[ch.number];
  var player = document.getElementById('audio-player');
  var title = document.getElementById('player-title');
  if (audio) {
    title.textContent = 'Ch ' + ch.number + ': ' + ch.title;
    player.src = audio.file;
    player.style.display = 'block';
  } else {
    title.textContent = 'No audio for this chapter';
    player.style.display = 'none';
    player.src = '';
  }
}

/* ==================== Render: Rail Minicard ==================== */
function renderRail() {
  var c = DATA.character;
  var el = document.getElementById('rail-minicard');
  if (!c) { el.innerHTML = ''; return; }
  var cur = c.hp ? c.hp.current : 0;
  var max = c.hp ? c.hp.max : 1;
  var pct = Math.max(0, Math.min(100, (cur / Math.max(max, 1)) * 100));
  var state = hpState(cur, max);
  var cls = state === 'critical' ? ' critical' : (state === 'wounded' ? ' wounded' : '');
  var h = '<div style="font-size:18px">&#9876;</div>';
  h += '<div class="minicard-hp"><div class="minicard-hp-fill' + cls + '" style="width:' + pct + '%"></div></div>';
  h += '<div class="minicard-label">' + cur + '/' + max + '</div>';
  h += '<div class="minicard-label" style="color:var(--amber)">A' + (c.armor || 0) + '</div>';
  el.innerHTML = h;
}

/* ==================== Render: Bottom Bar ==================== */
function renderBottomBar() {
  var el = document.getElementById('bottom-bar');
  var h = '';

  /* Resources — countdown dice */
  var cdice = DATA.countdown_dice || [];
  if (cdice.length) {
    h += '<div class="bar-section"><span class="bar-label">Resources</span>';
    cdice.forEach(function(cd) {
      var low = cd.current_die <= 4;
      var icon = '';
      var cat = (cd.category || cd.name || '').toLowerCase();
      if (cat.indexOf('torch') >= 0) icon = '&#128293;';
      else if (cat.indexOf('ration') >= 0 || cat.indexOf('food') >= 0) icon = '&#127830;';
      else if (cat.indexOf('arrow') >= 0 || cat.indexOf('ammo') >= 0) icon = '&#127993;';
      else icon = '&#9670;';
      var label = cd.current_die === 0 ? 'OUT' : 'd' + cd.current_die;
      h += '<span class="bar-countdown' + (low ? ' low' : '') + '"><span class="bar-countdown-icon">' + icon + '</span> ' + label + '</span>';
    });
    h += '</div><div class="bar-divider"></div>';
  }

  /* Clocks */
  var clocks = DATA.clocks || [];
  var activeClocks = clocks.slice(0, 3);
  if (activeClocks.length) {
    h += '<div class="bar-section"><span class="bar-label">Clocks</span>';
    activeClocks.forEach(function(cl) {
      h += '<div class="bar-clock">' + clockSegmentsHtml(cl.segments_filled, cl.total_segments);
      h += '<span class="bar-clock-label">' + esc(cl.name) + '</span></div>';
    });
    h += '</div><div class="bar-divider"></div>';
  }

  /* Doom portents */
  var dooms = DATA.dooms || [];
  var activeDooms = dooms.filter(function(d) { return d.portent_level > 0; }).slice(0, 3);
  if (activeDooms.length) {
    h += '<div class="bar-section"><span class="bar-label">Portents</span>';
    activeDooms.forEach(function(d) {
      h += '<div class="bar-doom">';
      h += '<div class="bar-doom-pips">';
      for (var i = 0; i < 6; i++) {
        h += '<div class="bar-doom-pip' + (i < d.portent_level ? ' filled' : '') + '"></div>';
      }
      h += '</div><span class="bar-doom-label">' + esc(d.name) + '</span></div>';
    });
    h += '</div><div class="bar-divider"></div>';
  }

  /* Calendar date */
  var cal = DATA.calendar || {};
  var dateStr = cal.date || null;
  h += '<div class="bar-section"><div class="bar-calendar"><span class="bar-calendar-icon">&#128197;</span> ' + esc(dateStr || '\u2014') + '</div></div>';

  /* Danger level */
  var loc = DATA.location || {};
  h += '<div class="bar-right">' + dangerBadge(loc.danger_level) + '</div>';

  el.innerHTML = h;
}

/* ==================== Render: Drawer ==================== */
function renderDrawer() {
  /* Quests tab */
  var qEl = document.getElementById('drawer-quests');
  var q = DATA.quests || {};
  var qh = '';

  var active = q.active || [];
  var developing = q.developing || [];
  var completed = q.completed || [];

  if (active.length) {
    qh += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim);margin-bottom:6px">Active</div>';
    active.forEach(function(i) {
      var name = typeof i === 'string' ? i : (i.name || i);
      var desc = typeof i === 'object' ? i.desc : null;
      qh += '<div class="dq-item"><div class="dq-header"><span class="pill pill-active">Active</span><span class="dq-name">' + esc(name) + '</span></div>';
      if (desc) qh += '<div class="dq-desc">' + esc(desc) + '</div>';
      qh += '</div>';
    });
  }

  if (developing.length) {
    qh += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim);margin:12px 0 6px">Developing</div>';
    developing.forEach(function(i) {
      var name = typeof i === 'string' ? i : (i.name || i);
      var desc = typeof i === 'object' ? i.desc : null;
      qh += '<div class="dq-item"><div class="dq-header"><span class="pill pill-developing">Developing</span><span class="dq-name">' + esc(name) + '</span></div>';
      if (desc) qh += '<div class="dq-desc">' + esc(desc) + '</div>';
      qh += '</div>';
    });
  }

  if (completed.length) {
    qh += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim);margin:12px 0 6px">Completed</div>';
    completed.forEach(function(i) {
      var name = typeof i === 'string' ? i : (i.name || i);
      qh += '<div class="dq-item"><div class="dq-header"><span class="pill pill-completed">Done</span><span class="dq-name" style="color:var(--text-dim)">' + esc(name) + '</span></div></div>';
    });
  }

  if (!active.length && !developing.length && !completed.length) {
    qh = '<div class="no-content" style="padding:20px 0">No quests yet</div>';
  }
  qEl.innerHTML = qh;

  /* NPCs tab */
  var nEl = document.getElementById('drawer-npcs');
  var npcs = DATA.npcs || [];
  var nh = '';
  if (npcs.length) {
    npcs.forEach(function(n) {
      nh += '<div class="dn-item">';
      nh += '<div class="dn-name">' + esc(n.name) + '</div>';
      if (n.location) nh += '<div class="dn-meta">' + esc(n.location) + '</div>';
      if (n.disposition) nh += '<span class="dn-disposition ' + ((n.disposition || '').toLowerCase()) + '">' + esc(n.disposition) + '</span>';
      nh += '</div>';
    });
  } else {
    nh = '<div class="no-content" style="padding:20px 0">No NPCs known</div>';
  }
  nEl.innerHTML = nh;

  /* Log tab */
  var lEl = document.getElementById('drawer-log');
  var journal = DATA.journal || [];
  var entries = journal.filter(function(e) { return typeof e === 'string' && e.trim() && !e.match(/^##?\s/) && !e.match(/^#/); });
  var recent = entries.slice(-20).reverse();
  var lh = '';
  if (recent.length) {
    recent.forEach(function(e) {
      var m = e.match(/\[(\w[\w-]*)\]/);
      var tag = m ? m[1] : null;
      var text = e.replace(/\[[\w-]+\]\s*/g, '').replace(/^-\s*/, '');
      lh += '<div class="dl-entry">';
      if (tag) lh += tagSpan(tag);
      lh += '<span class="dl-text">' + esc(text) + '</span></div>';
    });
  } else {
    lh = '<div class="no-content" style="padding:20px 0">No log entries</div>';
  }
  lEl.innerHTML = lh;
}

/* ==================== Render: Player View ==================== */
function renderPlayer() {
  var c = DATA.character;
  var el = document.getElementById('view-player');
  if (!c) { el.innerHTML = '<div class="no-content">No character data.</div>'; return; }

  var hpCur = c.hp ? c.hp.current : 0;
  var hpMax = c.hp ? c.hp.max : 1;
  var stats = c.stats || {};
  var statNames = ['vigor', 'reflex', 'wits', 'resolve', 'presence', 'lore'];
  var statLabels = { vigor: 'VIG', reflex: 'REF', wits: 'WIT', resolve: 'RES', presence: 'PRE', lore: 'LOR' };
  var training = c.training || [];

  /* Build skill->stat lookup */
  var trainedByStat = {};
  statNames.forEach(function(s) { trainedByStat[s] = []; });
  training.forEach(function(sk) {
    var mapped = SKILL_STAT_MAP[sk];
    if (mapped && trainedByStat[mapped]) trainedByStat[mapped].push(sk);
  });

  var h = '';

  /* View header */
  h += '<div class="view-header"><div style="display:flex;align-items:baseline;gap:8px">';
  h += '<span class="view-title">Character Sheet</span>';
  h += '</div></div>';

  /* Hero banner */
  h += '<div class="char-hero">';
  h += '<div class="char-avatar">&#9876;</div>';
  h += '<div class="char-identity"><h2>' + esc(c.name) + '</h2>';
  h += '<div class="char-meta">' + esc((c.ancestry || '') + ' ' + (c.class || '') + ' \u2014 Level ' + (c.level || 1));
  if (c.background) h += ' \u00b7 ' + esc(c.background);
  h += '</div></div>';
  h += '<div class="char-vitals">';
  h += '<div class="vital-block"><div class="vital-value">' + hpCur + '</div><div class="vital-label">HP</div></div>';
  h += '<div class="vital-block"><div class="vital-value">' + (c.armor || 0) + '</div><div class="vital-label">Armor</div></div>';
  h += '<div class="vital-block"><div class="vital-value" style="color:var(--amber)">' + (c.gold || 0) + '</div><div class="vital-label">Gold</div></div>';
  h += '</div></div>';

  /* HP bar */
  h += hpBarHtml(hpCur, hpMax);

  /* Death clock */
  var deathClock = c.death_clock || 0;
  if (deathClock > 0) {
    h += '<div style="margin-bottom:16px;display:flex;align-items:center;gap:10px;padding:8px 16px;background:var(--red-dim);border:1px solid var(--red);border-radius:var(--radius-lg)">';
    h += '<div class="death-clock"><div class="death-clock-pips">';
    for (var di = 0; di < 4; di++) {
      h += '<div class="death-pip' + (di < deathClock ? ' filled' : '') + '"></div>';
    }
    h += '</div><span class="death-clock-label">Death Clock ' + deathClock + '/4</span></div></div>';
  }

  /* Stats grid */
  h += '<div class="stats-grid">';
  statNames.forEach(function(s) {
    var val = stats[s] || 5;
    var dc = difficulty(val, false);
    var color = STAT_COLORS[s];
    var skills = trainedByStat[s] || [];
    h += '<div class="stat-cell" style="--stat-color:' + color + '">';
    h += '<div class="stat-value">' + val + '</div>';
    h += '<div class="stat-name">' + statLabels[s] + '</div>';
    h += '<div class="stat-dc">DC ' + dc + '</div>';
    if (skills.length) {
      h += '<div class="stat-trained">' + skills.join(', ') + '</div>';
    }
    h += '</div>';
  });
  h += '</div>';

  /* Two-col: Training + Countdown Dice */
  h += '<div class="two-col">';

  /* Training */
  h += '<div class="card"><div class="card-header"><span class="card-title">Training</span></div><div class="card-body">';
  if (training.length) {
    h += '<div class="training-list">';
    training.forEach(function(t) { h += '<span class="training-pill">' + esc(t) + '</span>'; });
    h += '</div>';
    var langs = c.languages || [];
    if (langs.length) h += '<div style="font-size:11px;color:var(--text-dim);margin-top:8px">Languages: ' + esc(langs.join(', ')) + '</div>';
  } else {
    h += '<div style="color:var(--text-dim);font-style:italic;font-size:12px">No training</div>';
  }
  h += '</div></div>';

  /* Countdown dice */
  var cdice = DATA.countdown_dice || [];
  h += '<div class="card"><div class="card-header"><span class="card-title">Countdown Dice</span></div><div class="card-body">';
  if (cdice.length) {
    cdice.forEach(function(cd) {
      var low = cd.current_die <= 4 && cd.current_die > 0;
      var label = cd.current_die === 0 ? 'OUT' : 'd' + cd.current_die;
      h += '<div class="countdown-row"><span class="countdown-name">' + esc(cd.name) + '</span>';
      h += '<span class="countdown-die' + (low ? ' low' : '') + '">' + label + '</span></div>';
    });
  } else {
    h += '<div style="color:var(--text-dim);font-style:italic;font-size:12px">No active dice</div>';
  }
  h += '</div></div>';

  h += '</div>';

  /* Inventory */
  var inv = c.inventory || [];
  var used = c.used_gear_slots || inv.length;
  var maxSlots = c.max_gear_slots || 10;
  h += '<div class="card"><div class="card-header"><span class="card-title">Inventory</span>';
  h += '<span class="card-badge">' + used + ' / ' + maxSlots + ' slots</span></div><div class="card-body">';
  if (inv.length) {
    inv.forEach(function(i) {
      var name = typeof i === 'string' ? i : (i.name || '');
      var detail = typeof i === 'object' ? (i.notes || i.qty || '') : '';
      h += '<div class="inventory-item"><span class="inventory-item-name">' + esc(name) + '</span>';
      if (detail) h += '<span class="inventory-item-detail">' + esc(detail) + '</span>';
      h += '</div>';
    });
  } else {
    h += '<div style="color:var(--text-dim);font-style:italic;font-size:12px">Empty</div>';
  }
  var worn = c.worn || [];
  if (worn.length) {
    h += '<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:11px;color:var(--text-dim)">';
    h += 'Worn: ' + esc(worn.join(', ')) + '</div>';
  }
  h += '</div></div>';

  /* Two-col: Class features + Ancestry traits */
  var classFeatures = c.class_features || [];
  var ancestryTraits = c.ancestry_traits || [];
  var talents = c.talents || [];
  if (classFeatures.length || ancestryTraits.length || talents.length) {
    h += '<div class="two-col">';

    h += '<div class="card" id="player-feat-card"><div class="sub-tabs">';
    h += '<button class="sub-tab active" data-tab="pclass" onclick="switchSubTab(\'player-feat-card\',\'pclass\')">Class</button>';
    h += '<button class="sub-tab" data-tab="pancestry" onclick="switchSubTab(\'player-feat-card\',\'pancestry\')">Ancestry</button>';
    if (talents.length) h += '<button class="sub-tab" data-tab="ptalents" onclick="switchSubTab(\'player-feat-card\',\'ptalents\')">Talents</button>';
    h += '</div><div class="card-body">';
    h += '<div class="sub-pane active" data-pane="pclass">';
    if (classFeatures.length) classFeatures.forEach(function(f) { h += '<div class="feature-item">' + esc(f) + '</div>'; });
    else h += '<div style="color:var(--text-dim);font-style:italic;font-size:12px">None</div>';
    h += '</div>';
    h += '<div class="sub-pane" data-pane="pancestry">';
    if (ancestryTraits.length) ancestryTraits.forEach(function(f) { h += '<div class="feature-item">' + esc(f) + '</div>'; });
    else h += '<div style="color:var(--text-dim);font-style:italic;font-size:12px">None</div>';
    h += '</div>';
    if (talents.length) {
      h += '<div class="sub-pane" data-pane="ptalents">';
      talents.forEach(function(t) { h += '<div class="feature-item">' + esc(t) + '</div>'; });
      h += '</div>';
    }
    h += '</div></div>';

    /* Spells (right column of two-col) */
    var spells = c.spells || [];
    if (spells.length) {
      h += '<div class="card"><div class="card-header"><span class="card-title">Spells</span></div><div class="card-body">';
      spells.forEach(function(s) { h += '<div class="spell-item">' + esc(s) + '</div>'; });
      h += '</div></div>';
    } else {
      /* Location as fallback for right column */
      var loc = DATA.location;
      if (loc) {
        h += '<div class="card"><div class="card-header"><span class="card-title">Location</span>' + dangerBadge(loc.danger_level) + '</div><div class="card-body">';
        h += '<div style="font-family:var(--font-display);font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px">' + esc(loc.name) + '</div>';
        if (loc.description) h += '<div class="loc-desc">' + esc(loc.description) + '</div>';
        h += '</div></div>';
      }
    }

    h += '</div>';
  }

  /* Location card (if not rendered in two-col above) */
  var loc = DATA.location;
  if (loc && (c.spells || []).length > 0) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Current Location</span>' + dangerBadge(loc.danger_level) + '</div><div class="card-body">';
    h += '<div style="font-family:var(--font-display);font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px">' + esc(loc.name) + '</div>';
    if (loc.light) h += '<div style="font-size:11px;color:var(--text-dim);margin-bottom:4px">Light: ' + esc(loc.light) + '</div>';
    if (loc.description) h += '<div class="loc-desc">' + esc(loc.description) + '</div>';
    h += '</div></div>';
  }

  el.innerHTML = h;
}

/* ==================== Render: GM View ==================== */
function renderGM() {
  var el = document.getElementById('view-gm');
  var h = '';
  var prep = DATA.gm_notes || {};

  /* View header */
  h += '<div class="view-header"><span class="view-title">GM Screen</span></div>';

  /* Strong Start */
  if (prep.strong_start) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Strong Start</span></div>';
    h += '<div class="card-body"><div style="font-size:12px;color:var(--text-secondary);line-height:1.7">' + esc(prep.strong_start) + '</div></div></div>';
  }

  /* Secrets */
  var secrets = prep.secrets || [];
  if (secrets.length) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Active Secrets</span>';
    h += '<span class="card-badge">' + secrets.length + ' secrets</span></div><div class="card-body">';
    secrets.forEach(function(s) {
      h += '<div class="secret-item">';
      if (typeof s === 'object' && s !== null) {
        h += '<div class="secret-label">' + esc(s.label || s.name || '') + '</div>';
        if (s.info) h += '<div class="secret-info">' + esc(s.info) + '</div>';
        if (s.discovery) {
          var paths = Array.isArray(s.discovery) ? s.discovery.join(' \u00b7 ') : s.discovery;
          h += '<div class="secret-discovery">Discovery: ' + esc(paths) + '</div>';
        }
      } else {
        h += '<div class="secret-info">' + esc(s) + '</div>';
      }
      h += '</div>';
    });
    h += '</div></div>';
  }

  /* NPC Moves */
  var npcMoves = prep.npcs_to_use || prep.npc_moves || [];
  if (npcMoves.length) {
    h += '<div class="card"><div class="card-header"><span class="card-title">NPC Moves</span></div><div class="card-body">';
    h += '<div style="font-size:12px;color:var(--text-secondary);line-height:1.6">';
    npcMoves.forEach(function(n) {
      if (typeof n === 'object' && n !== null) {
        h += '<div style="margin-bottom:8px"><strong style="color:var(--text)">' + esc(n.name || '') + '</strong>';
        if (n.action || n.move) h += ' \u2014 ' + esc(n.action || n.move);
        h += '</div>';
      } else {
        h += '<div style="margin-bottom:4px">' + esc(n) + '</div>';
      }
    });
    h += '</div></div></div>';
  }

  /* Scenes */
  var scenes = prep.scenes || [];
  if (scenes.length) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Potential Scenes</span></div><div class="card-body">';
    h += '<div style="font-size:12px;color:var(--text-secondary);line-height:1.6">';
    scenes.forEach(function(s) {
      if (typeof s === 'object' && s !== null) {
        h += '<div style="margin-bottom:8px"><strong style="color:var(--text)">' + esc(s.name || s.label || '') + '</strong>';
        if (s.description || s.info) h += ' \u2014 ' + esc(s.description || s.info);
        h += '</div>';
      } else {
        h += '<div style="margin-bottom:4px">\u203A ' + esc(s) + '</div>';
      }
    });
    h += '</div></div></div>';
  }

  /* Encounters + Treasure in two-col */
  var encounters = prep.encounters || [];
  var treasure = prep.treasure || [];
  if (encounters.length || treasure.length) {
    h += '<div class="two-col">';
    if (encounters.length) {
      h += '<div class="card"><div class="card-header"><span class="card-title">Encounters</span></div><div class="card-body">';
      h += '<div style="font-size:12px;color:var(--text-secondary);line-height:1.6">';
      encounters.forEach(function(e) {
        if (typeof e === 'object' && e !== null) {
          h += '<div style="margin-bottom:6px"><strong style="color:var(--text)">' + esc(e.name || e.label || '') + '</strong>';
          if (e.description || e.info) h += ' \u2014 ' + esc(e.description || e.info);
          h += '</div>';
        } else {
          h += '<div style="margin-bottom:4px">\u2022 ' + esc(e) + '</div>';
        }
      });
      h += '</div></div></div>';
    }
    if (treasure.length) {
      h += '<div class="card"><div class="card-header"><span class="card-title">Treasure</span></div><div class="card-body">';
      h += '<div style="font-size:12px;color:var(--text-secondary);line-height:1.6">';
      treasure.forEach(function(t) {
        if (typeof t === 'object' && t !== null) {
          h += '<div style="margin-bottom:6px"><strong style="color:var(--amber)">' + esc(t.name || t.label || '') + '</strong>';
          if (t.description || t.info) h += ' \u2014 ' + esc(t.description || t.info);
          h += '</div>';
        } else {
          h += '<div style="margin-bottom:4px">\u2022 ' + esc(t) + '</div>';
        }
      });
      h += '</div></div></div>';
    }
    h += '</div>';
  }

  /* NPC Combat Stats Grid */
  var npcs = DATA.npcs || [];
  var combatNpcs = npcs.filter(function(n) { return n.hp || n.armor || n.attack_die; });
  if (combatNpcs.length) {
    h += '<div class="card"><div class="card-header"><span class="card-title">NPC Combat Stats</span></div><div class="card-body">';
    h += '<div class="npc-combat-grid">';
    combatNpcs.forEach(function(n) {
      h += '<div class="npc-combat-card">';
      h += '<div class="npc-combat-name">' + esc(n.name) + '</div>';
      h += '<div class="npc-stat-row">';
      if (n.hp) h += '<span>HP <span class="val">' + (typeof n.hp === 'object' ? n.hp.current + '/' + n.hp.max : n.hp) + '</span></span>';
      if (n.armor) h += '<span>Armor <span class="val">' + n.armor + '</span></span>';
      if (n.attack_die) h += '<span>Atk <span class="val">' + esc(n.attack_die) + '</span></span>';
      if (n.zone) h += '<span>Zone <span class="val">' + esc(n.zone) + '</span></span>';
      if (n.morale) h += '<span>ML <span class="val">' + n.morale + '</span></span>';
      if (n.weakness) h += '<span>Weak <span class="val">' + esc(n.weakness) + '</span></span>';
      h += '</div></div>';
    });
    h += '</div></div></div>';
  }

  /* Doom portent tracks */
  var dooms = DATA.dooms || [];
  if (dooms.length) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Doom Portents</span></div><div class="card-body">';
    dooms.forEach(function(d) {
      h += '<div class="doom-track">';
      h += '<span class="doom-name">' + esc(d.name) + '</span>';
      h += doomPipsHtml(d.portent_level, 6);
      h += '<span class="doom-portent-label">' + d.portent_level + '/6</span>';
      h += '</div>';
    });
    h += '</div></div>';
  }

  /* Progress clocks */
  var clocks = DATA.clocks || [];
  if (clocks.length) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Progress Clocks</span></div><div class="card-body">';
    clocks.forEach(function(cl) {
      h += '<div class="clock-row">';
      h += clockSvg(cl.segments_filled, cl.total_segments);
      h += '<div><div class="clock-label">' + esc(cl.name) + '</div>';
      h += '<div class="clock-meta">' + cl.segments_filled + '/' + cl.total_segments;
      if (cl.trigger) h += ' \u2014 ' + esc(cl.trigger);
      h += '</div></div></div>';
    });
    h += '</div></div>';
  }

  /* Difficulty Reference */
  h += '<div class="card"><div class="card-header"><span class="card-title">Difficulty Reference</span></div><div class="card-body">';
  h += '<div class="dc-reference">Difficulty = 20 \u2212 Stat (untrained)<br>Difficulty = 20 \u2212 Stat\u00d72 (trained)<br>Critical: beat DC by 5+<br>Death Clock: 4 segments, 1 per failed death save</div>';
  h += '</div></div>';

  el.innerHTML = h;
}

/* ==================== Render: Campaign View ==================== */
function renderCampaign() {
  var el = document.getElementById('view-campaign');
  var h = '';
  var ctx = DATA.campaign_context || {};
  var mem = DATA.campaign_memory || {};
  var meta = DATA.session_metadata || {};

  /* View header */
  h += '<div class="view-header"><span class="view-title">Campaign Overview</span></div>';

  /* Campaign banner */
  h += '<div class="campaign-banner">';
  h += '<div class="campaign-title">' + esc(ctx.name || ctx.setting || 'Campaign') + '</div>';
  if (ctx.tone || ctx.premise) h += '<div class="campaign-subtitle">"' + esc(ctx.tone || ctx.premise) + '"</div>';
  var bannerParts = [];
  if (meta.sessions_played) bannerParts.push(meta.sessions_played + ' sessions');
  if (meta.first_played) bannerParts.push('Started ' + meta.first_played);
  if (bannerParts.length) h += '<div class="campaign-meta">' + esc(bannerParts.join(' \u00b7 ')) + '</div>';
  h += '</div>';

  /* Calendar */
  var cal = DATA.calendar || {};
  if (cal.date || cal.season || cal.weather) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Calendar</span></div><div class="card-body">';
    if (cal.date) h += '<div class="calendar-date">' + esc(cal.date) + '</div>';
    var details = [];
    if (cal.season) details.push(cal.season);
    if (cal.weather) details.push(cal.weather);
    if (details.length) h += '<div class="calendar-detail">' + esc(details.join(' \u00b7 ')) + '</div>';
    h += '</div></div>';
  }

  /* World State */
  if (mem.world_state) {
    h += '<div class="card"><div class="card-header"><span class="card-title">World State</span></div><div class="card-body">';
    h += '<div class="world-state-text">' + esc(mem.world_state) + '</div>';
    h += '</div></div>';
  }

  /* Doom portent tracks */
  var dooms = DATA.dooms || [];
  if (dooms.length) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Doom Portents</span></div><div class="card-body">';
    dooms.forEach(function(d) {
      h += '<div class="doom-track">';
      h += '<span class="doom-name">' + esc(d.name) + '</span>';
      h += doomPipsHtml(d.portent_level, 6);
      h += '<span class="doom-portent-label">' + d.portent_level + '/6';
      if (d.current_portent) h += ' \u2014 ' + esc(d.current_portent);
      h += '</span></div>';
    });
    h += '</div></div>';
  }

  /* Factions */
  var factions = DATA.factions || [];
  if (factions.length) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Factions</span></div><div class="card-body">';
    factions.forEach(function(f) {
      h += '<div class="faction-card">';
      h += '<div class="faction-name">' + esc(f.name) + '</div>';
      var badges = '';
      if (f.disposition) badges += dispositionPill(f.disposition);
      if (f.members) badges += ' <span class="pill pill-neutral">' + esc(f.members) + '</span>';
      if (badges) h += '<div style="margin:4px 0">' + badges + '</div>';
      if (f.goals) h += '<div class="faction-goals">' + esc(f.goals) + '</div>';
      h += '</div>';
    });
    h += '</div></div>';
  }

  /* Quest tracker */
  var q = DATA.quests || {};
  var qActive = q.active || [];
  var qDeveloping = q.developing || [];
  var qCompleted = q.completed || [];
  if (qActive.length || qDeveloping.length || qCompleted.length) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Quest Tracker</span></div><div class="card-body">';
    if (qActive.length) {
      h += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim);margin-bottom:6px">Active (' + qActive.length + ')</div>';
      qActive.forEach(function(i) {
        var name = typeof i === 'string' ? i : (i.name || i);
        var desc = typeof i === 'object' ? i.desc : null;
        var progress = typeof i === 'object' ? i.progress : null;
        h += '<div class="quest-card"><div class="quest-name">' + esc(name) + '</div>';
        if (desc) h += '<div class="quest-desc">' + esc(desc) + '</div>';
        if (progress) h += '<div style="font-size:10px;color:var(--text-dim);margin-top:2px">' + esc(progress) + '</div>';
        h += '</div>';
      });
    }
    if (qDeveloping.length) {
      h += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim);margin:10px 0 6px">Developing (' + qDeveloping.length + ')</div>';
      qDeveloping.forEach(function(i) {
        var name = typeof i === 'string' ? i : (i.name || i);
        h += '<div class="quest-card developing"><div class="quest-name">' + esc(name) + '</div></div>';
      });
    }
    if (qCompleted.length) {
      h += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim);margin:10px 0 6px">Completed (' + qCompleted.length + ')</div>';
      qCompleted.forEach(function(i) {
        var name = typeof i === 'string' ? i : (i.name || i);
        h += '<div class="quest-card completed"><div class="quest-name" style="color:var(--text-dim)">' + esc(name) + '</div></div>';
      });
    }
    h += '</div></div>';
  }

  /* Session timeline */
  var groups = parseJournal(DATA.journal);
  if (groups.length) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Session Timeline</span></div><div class="card-body">';
    groups.slice().reverse().forEach(function(g) {
      h += '<div class="timeline-session">';
      h += '<div class="timeline-label">' + esc(g.label) + '</div>';
      g.entries.slice(0, 8).forEach(function(e) {
        var text = e.replace(/\[[\w-]+\]\s*/g, '').replace(/^-\s*/, '');
        h += '<div class="timeline-entry">' + esc(text) + '</div>';
      });
      if (g.entries.length > 8) {
        h += '<div class="timeline-entry" style="color:var(--text-dim)">+ ' + (g.entries.length - 8) + ' more...</div>';
      }
      h += '</div>';
    });
    h += '</div></div>';
  }

  /* Active threads */
  var threads = (mem.active_threads || DATA.open_threads || []);
  if (threads.length) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Active Threads</span></div><div class="card-body">';
    h += '<div style="font-size:12px;color:var(--text-secondary)">';
    threads.forEach(function(t) {
      var text = typeof t === 'string' ? t : (t.text || t.name || '');
      h += '<div style="padding:2px 0">\u203A ' + esc(text) + '</div>';
    });
    h += '</div></div></div>';
  }

  el.innerHTML = h;
}

/* ==================== Render: Media View ==================== */
function renderMedia() {
  var el = document.getElementById('view-media');
  var chapters = DATA.chapters || [];
  var audiobooks = DATA.audiobooks || [];

  if (!chapters.length && !audiobooks.length) {
    el.innerHTML = '<div class="view-header"><span class="view-title">Story & Audio</span></div>' +
      '<div class="no-content">No chronicles written yet. Use /glintlock:chronicle to generate a chapter.</div>';
    return;
  }

  var audioMap = {};
  audiobooks.forEach(function(ab) { audioMap[ab.chapter] = ab; });

  var h = '<div class="media-layout">';

  /* Chapter list */
  h += '<div class="media-list">';
  chapters.forEach(function(ch, i) {
    var hasAudio = !!audioMap[ch.number];
    h += '<button class="chapter-item' + (i === 0 ? ' active' : '') + '" data-idx="' + i + '" onclick="selectChapter(' + i + ')">';
    h += '<span class="ch-num">Ch ' + ch.number + '</span>';
    h += '<span class="ch-title">' + esc(ch.title) + '</span>';
    if (hasAudio) h += '<span class="ch-status ch-status-audio">Audio</span>';
    else h += '<span class="ch-status ch-status-read">Read</span>';
    h += '</button>';
  });
  h += '</div>';

  /* Audio player */
  h += '<div class="media-player" id="media-player-wrap">';
  h += '<div class="player-title" id="player-title">No audio selected</div>';
  h += '<audio id="audio-player" controls preload="metadata" style="display:none"></audio>';
  h += '</div>';

  /* Reader */
  h += '<div class="media-reader"><div id="chapter-content" class="chapter-prose"></div></div>';

  h += '</div>';

  el.innerHTML = h;
  if (chapters.length) selectChapter(0);
}

/* ==================== Render: Analytics View ==================== */
function renderAnalytics() {
  var el = document.getElementById('view-analytics');
  var meta = DATA.session_metadata || {};
  var npcs = DATA.npcs || [];
  var dooms = DATA.dooms || [];
  var journal = DATA.journal || [];

  var h = '';

  /* View header */
  h += '<div class="view-header"><span class="view-title">Analytics</span><span class="view-subtitle">Campaign statistics</span></div>';

  /* Summary stats */
  var daysActive = '\u2014';
  if (meta.first_played && meta.last_played) {
    var d1 = new Date(meta.first_played);
    var d2 = new Date(meta.last_played);
    var diff = Math.max(1, Math.round((d2 - d1) / (1000 * 60 * 60 * 24)));
    daysActive = diff;
  }

  h += '<div class="analytics-grid">';
  h += '<div class="analytics-stat"><div class="analytics-value">' + daysActive + '</div><div class="analytics-label">Days Active</div></div>';
  h += '<div class="analytics-stat"><div class="analytics-value">' + (meta.sessions_played || '\u2014') + '</div><div class="analytics-label">Play Sessions</div></div>';
  h += '<div class="analytics-stat"><div class="analytics-value">' + npcs.length + '</div><div class="analytics-label">NPCs Met</div></div>';
  h += '<div class="analytics-stat"><div class="analytics-value">' + dooms.length + '</div><div class="analytics-label">Active Dooms</div></div>';
  h += '</div>';

  /* Doom portent summary */
  if (dooms.length) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Doom Status Overview</span></div><div class="card-body">';
    dooms.forEach(function(d) {
      h += '<div class="doom-track">';
      h += '<span class="doom-name">' + esc(d.name) + '</span>';
      h += doomPipsHtml(d.portent_level, 6);
      h += '<span class="doom-portent-label">' + d.portent_level + '/6</span>';
      h += '</div>';
    });
    h += '</div></div>';
  }

  /* Activity distribution placeholder */
  h += '<div class="card"><div class="card-header"><span class="card-title">Activity Distribution</span></div><div class="card-body">';
  var eventCount = 0, discoveryCount = 0, threadCount = 0, advanceCount = 0, rulingCount = 0;
  journal.forEach(function(e) {
    if (typeof e !== 'string') return;
    if (e.indexOf('[event]') >= 0) eventCount++;
    if (e.indexOf('[discovery]') >= 0) discoveryCount++;
    if (e.indexOf('[thread]') >= 0) threadCount++;
    if (e.indexOf('[world-advance]') >= 0) advanceCount++;
    if (e.indexOf('[ruling]') >= 0) rulingCount++;
  });
  var categories = [
    [eventCount, 'var(--amber)', 'Events'],
    [discoveryCount, 'var(--green)', 'Discoveries'],
    [threadCount, 'var(--blue)', 'Threads'],
    [advanceCount, 'var(--red)', 'World Advances'],
    [rulingCount, 'var(--violet)', 'Rulings']
  ];
  h += '<div style="display:flex;gap:8px;margin-bottom:12px">';
  categories.forEach(function(cat) {
    var numColor = cat[0] > 0 ? cat[1] : 'var(--text-dim)';
    h += '<div style="flex:1;display:flex;flex-direction:column;align-items:center">';
    h += '<div style="font-family:var(--font-mono);font-size:20px;color:' + numColor + '">' + cat[0] + '</div>';
    h += '<div style="font-size:10px;color:var(--text-dim)">' + cat[2] + '</div></div>';
  });
  h += '</div>';

  var total = eventCount + discoveryCount + threadCount + advanceCount + rulingCount;
  if (total > 0) {
    /* Simple bar chart */
    var maxCount = Math.max(eventCount, discoveryCount, threadCount, advanceCount, rulingCount, 1);
    h += '<div style="display:flex;gap:4px;height:60px;align-items:flex-end">';
    categories.forEach(function(cat) {
      var pct = Math.max(4, (cat[0] / maxCount) * 100);
      h += '<div style="flex:1;background:' + cat[1] + ';height:' + pct + '%;border-radius:3px 3px 0 0;opacity:0.7"></div>';
    });
    h += '</div>';
  }
  h += '</div></div>';

  /* Character progression note */
  var c = DATA.character || {};
  if (c.name) {
    h += '<div class="card"><div class="card-header"><span class="card-title">Character Summary</span></div><div class="card-body">';
    h += '<div style="font-size:12px;color:var(--text-secondary);line-height:1.7">';
    h += '<strong style="color:var(--text)">' + esc(c.name) + '</strong> \u2014 Level ' + (c.level || 1) + ' ' + esc(c.ancestry || '') + ' ' + esc(c.class || '');
    if (c.hp) h += '<br>HP: ' + (c.hp.current || 0) + '/' + (c.hp.max || 0);
    h += '<br>Armor: ' + (c.armor || 0) + ' \u00b7 Gold: ' + (c.gold || 0);
    h += '</div></div></div>';
  }

  el.innerHTML = h;
}

/* ==================== Init ==================== */
renderRail();
renderBottomBar();
renderDrawer();
renderPlayer();
renderGM();
renderCampaign();
renderMedia();
renderAnalytics();

var initView = DATA.dashboard_type || 'player';
if (initView !== 'player') switchView(initView);
</script>
</body>
</html>
