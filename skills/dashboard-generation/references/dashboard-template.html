<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Glintlock — Campaign Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=DM+Sans:wght@400;500;600&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    /* Surfaces — deep navy */
    --background:  #080a0f;
    --surface-1:   #0d1017;
    --surface-2:   #12151e;
    --surface-3:   #161a24;
    --surface-4:   #1a1f2a;

    /* Text — warm parchment */
    --text:           #e2ddd5;
    --text-secondary: #b0aaa2;
    --text-muted:     #7a7680;
    --text-dim:       #4e4b55;

    /* Brand & status */
    --primary:        #d4622a;
    --primary-bright: #e8773a;
    --primary-soft:   rgba(212, 98, 42, 0.1);
    --success:        #3ddc84;
    --success-soft:   rgba(61, 220, 132, 0.1);
    --warning:        #eab308;
    --warning-soft:   rgba(234, 179, 8, 0.1);
    --danger:         #ef4444;
    --danger-soft:    rgba(239, 68, 68, 0.1);
    --discord:        #5865F2;
    --discord-soft:   rgba(88, 101, 242, 0.1);
    --violet:         #a78bfa;
    --violet-soft:    rgba(167, 139, 250, 0.1);

    /* Borders */
    --border:        #1c2030;
    --border-light:  #252a3a;
    --border-accent: rgba(212, 98, 42, 0.25);

    /* Typography */
    --font-display:   'Cinzel', serif;
    --font-body:      'DM Sans', system-ui, sans-serif;
    --font-narrative: 'Crimson Pro', serif;
    --font-mono:      'JetBrains Mono', monospace;

    /* Stat accent colors */
    --stat-vigor:    #d4622a;
    --stat-reflex:   #2dd4bf;
    --stat-wits:     #eab308;
    --stat-resolve:  #a78bfa;
    --stat-presence: #f472b6;
    --stat-lore:     #5865F2;

    /* Radius */
    --radius:    8px;
    --radius-sm: 6px;
    --radius-lg: 12px;
    --radius-pill: 20px;

    /* Shadows */
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.4);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.5);

    /* Layout */
    --sidebar-width: 220px;
    --header-height: 48px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--background);
    color: var(--text);
    font-family: var(--font-body);
    font-size: 14px;
    line-height: 1.5;
    height: 100vh;
    overflow: hidden;
    display: grid;
    grid-template-columns: var(--sidebar-width) 1fr;
    grid-template-rows: var(--header-height) 1fr;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    opacity: 0.018;
    pointer-events: none;
    z-index: 9999;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    background-repeat: repeat;
    background-size: 256px 256px;
  }

  /* ================= SCROLLBAR ================= */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* ================= HEADER ================= */
  .header {
    grid-column: 1 / -1;
    grid-row: 1;
    height: var(--header-height);
    display: flex;
    align-items: center;
    padding: 0 1.25rem;
    background: var(--surface-2);
    border-bottom: 1px solid var(--border);
    z-index: 10;
  }

  .header-brand {
    font-family: var(--font-display);
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--primary);
    letter-spacing: 0.18em;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .header-title {
    flex: 1;
    text-align: center;
    font-family: var(--font-display);
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 0.06em;
  }

  .header-meta {
    font-family: var(--font-mono);
    font-size: 0.68rem;
    color: var(--text-dim);
    white-space: nowrap;
  }

  /* ================= SIDEBAR ================= */
  .sidebar {
    grid-column: 1;
    grid-row: 2;
    background: var(--surface-1);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Character mini-card */
  .sidebar-minicard {
    padding: 0.85rem 0.75rem;
    border-bottom: 1px solid var(--border);
  }

  .mini-name {
    font-family: var(--font-display);
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--text);
    letter-spacing: 0.02em;
    margin-bottom: 0.1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .mini-subtitle {
    font-size: 0.68rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }

  .mini-hp-track {
    width: 100%;
    height: 14px;
    background: var(--surface-3);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    position: relative;
    overflow: hidden;
    margin-bottom: 0.4rem;
  }

  .mini-hp-fill {
    height: 100%;
    border-radius: var(--radius-sm);
    background: linear-gradient(90deg, #b84520, var(--primary), var(--primary-bright));
    transition: width 0.4s ease;
  }

  .mini-hp-fill.low { background: linear-gradient(90deg, #8b1a1a, var(--danger)); }

  .mini-hp-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: var(--font-mono);
    font-size: 0.58rem;
    font-weight: 500;
    color: var(--text);
    text-shadow: 0 1px 3px rgba(0,0,0,0.9);
  }

  .mini-stats {
    display: flex;
    gap: 0.6rem;
    font-family: var(--font-mono);
    font-size: 0.62rem;
    color: var(--text-muted);
  }

  .mini-stats .val { color: var(--text); font-weight: 500; }
  .mini-stats .gold { color: var(--warning); }

  /* Navigation */
  .sidebar-nav {
    padding: 0.6rem 0;
    flex: 1;
  }

  .nav-label {
    font-family: var(--font-mono);
    font-size: 0.55rem;
    font-weight: 500;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 0.4rem 0.75rem 0.25rem;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.75rem;
    font-size: 0.78rem;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-family: var(--font-body);
    border-left: 2px solid transparent;
    transition: color 0.15s, background 0.15s;
  }

  .nav-item:hover {
    color: var(--text-secondary);
    background: var(--surface-2);
  }

  .nav-item.active {
    color: var(--text);
    background: var(--surface-2);
    border-left-color: var(--primary);
  }

  .nav-icon {
    font-size: 0.85rem;
    width: 1.25rem;
    text-align: center;
    flex-shrink: 0;
  }

  /* Sidebar footer */
  .sidebar-footer {
    padding: 0.65rem 0.75rem;
    border-top: 1px solid var(--border);
  }

  .footer-location {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.7rem;
    color: var(--text-secondary);
    margin-bottom: 0.35rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .footer-location .loc-icon { color: var(--text-dim); }

  /* Level indicator (replaces XP bar) */
  .level-label {
    font-family: var(--font-mono);
    font-size: 0.55rem;
    color: var(--text-dim);
  }

  /* Portent track (doom portent bars) */
  .portent-track {
    width: 100%;
    height: 8px;
    background: var(--surface-1);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }

  .portent-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.4s ease;
  }

  .portent-fill.low    { background: var(--success); }
  .portent-fill.mid    { background: var(--warning); }
  .portent-fill.high   { background: var(--primary); }
  .portent-fill.crit   { background: var(--danger); }

  .doom-item {
    margin-bottom: 0.5rem;
  }

  .doom-name {
    font-size: 0.72rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 0.15rem;
  }

  .doom-portent-label {
    font-family: var(--font-mono);
    font-size: 0.55rem;
    color: var(--text-dim);
    margin-top: 0.1rem;
  }

  /* Progress clock (segmented circles) */
  .clock-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
  }

  .clock-svg {
    flex-shrink: 0;
  }

  .clock-label {
    font-size: 0.72rem;
    color: var(--text-secondary);
  }

  .clock-meta {
    font-family: var(--font-mono);
    font-size: 0.55rem;
    color: var(--text-dim);
  }

  /* Countdown dice */
  .cd-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.15rem 0;
    font-size: 0.72rem;
    color: var(--text-secondary);
  }

  .cd-die {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    font-weight: 500;
    padding: 0.1rem 0.35rem;
    border-radius: var(--radius-sm);
    background: var(--surface-4);
    border: 1px solid var(--border);
  }

  .cd-die.cd-ok       { color: var(--success); border-color: var(--success); }
  .cd-die.cd-warn     { color: var(--warning); border-color: var(--warning); }
  .cd-die.cd-danger   { color: var(--danger); border-color: var(--danger); }
  .cd-die.cd-dead     { color: var(--text-dim); border-color: var(--text-dim); text-decoration: line-through; }

  .danger-badge {
    font-family: var(--font-mono);
    font-size: 0.58rem;
    font-weight: 500;
  }

  .danger-safe    { color: var(--success); }
  .danger-unsafe  { color: var(--warning); }
  .danger-risky   { color: var(--primary); }
  .danger-deadly  { color: var(--danger); }

  /* ================= CONTENT AREA ================= */
  .content {
    grid-column: 2;
    grid-row: 2;
    overflow: hidden;
    position: relative;
  }

  .view {
    display: none;
    position: absolute;
    inset: 0;
    overflow-y: auto;
  }

  .view.active { display: grid; }

  /* ================= SHARED COMPONENTS ================= */

  /* Card */
  .card {
    background: var(--surface-3);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 0;
  }

  .card-header {
    padding: 0.55rem 0.75rem;
    border-bottom: 1px solid var(--border);
    font-family: var(--font-display);
    font-size: 0.68rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .card-header .chevron { color: var(--primary); }

  .card-body {
    padding: 0.65rem 0.75rem;
    overflow-y: auto;
    flex: 1;
    min-height: 0;
  }

  /* Pill badges */
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.1rem 0.45rem;
    border-radius: var(--radius-pill);
    font-family: var(--font-mono);
    font-size: 0.58rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    white-space: nowrap;
  }

  .pill-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .pill-alive { background: var(--success-soft); color: var(--success); }
  .pill-alive .pill-dot { background: var(--success); }
  .pill-deceased { background: var(--danger-soft); color: var(--danger); }
  .pill-deceased .pill-dot { background: var(--danger); }
  .pill-friendly { background: var(--success-soft); color: var(--success); }
  .pill-wary { background: var(--warning-soft); color: var(--warning); }
  .pill-hostile { background: var(--danger-soft); color: var(--danger); }
  .pill-neutral { background: rgba(122, 118, 128, 0.1); color: var(--text-muted); }

  .pill-active { background: var(--primary-soft); color: var(--primary); }
  .pill-developing { background: var(--discord-soft); color: var(--discord); }
  .pill-completed { background: rgba(122, 118, 128, 0.1); color: var(--text-dim); }

  /* Journal tag pills */
  .tag {
    display: inline-block;
    font-family: var(--font-mono);
    font-size: 0.52rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 0.06rem 0.3rem;
    border-radius: var(--radius-sm);
    margin-right: 0.25rem;
    vertical-align: middle;
  }

  .tag-event       { background: var(--primary-soft); color: var(--primary); }
  .tag-discovery   { background: var(--success-soft); color: var(--success); }
  .tag-thread      { background: var(--discord-soft); color: var(--discord); }
  .tag-ruling      { background: var(--violet-soft); color: var(--violet); }
  .tag-world-advance { background: var(--warning-soft); color: var(--warning); }

  /* Sub-tabs within cards */
  .sub-tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .sub-tab {
    padding: 0.35rem 0.65rem;
    font-family: var(--font-body);
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--text-dim);
    cursor: pointer;
    border: none;
    background: none;
    position: relative;
    transition: color 0.15s;
  }

  .sub-tab:hover { color: var(--text-muted); }

  .sub-tab.active {
    color: var(--primary);
  }

  .sub-tab.active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0.65rem;
    right: 0.65rem;
    height: 2px;
    background: var(--primary);
    border-radius: 2px 2px 0 0;
  }

  .sub-pane { display: none; }
  .sub-pane.active { display: block; }

  /* HP bar (reusable) */
  .hp-track {
    width: 100%;
    height: 20px;
    background: var(--surface-1);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    position: relative;
    overflow: hidden;
  }

  .hp-fill {
    height: 100%;
    border-radius: var(--radius-sm);
    background: linear-gradient(90deg, #b84520, var(--primary), var(--primary-bright));
    transition: width 0.4s ease;
  }

  .hp-fill.low { background: linear-gradient(90deg, #8b1a1a, var(--danger)); }

  .hp-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: var(--font-mono);
    font-size: 0.65rem;
    font-weight: 500;
    color: var(--text);
    text-shadow: 0 1px 3px rgba(0,0,0,0.9);
  }

  /* Compact HP bar (NPCs) */
  .hp-track-sm {
    width: 100%;
    height: 10px;
    background: var(--surface-1);
    border: 1px solid var(--border);
    border-radius: 3px;
    position: relative;
    overflow: hidden;
  }

  .hp-track-sm .hp-fill { border-radius: 3px; }

  /* Section heading */
  .section-heading {
    font-family: var(--font-display);
    font-size: 0.68rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.5rem;
  }

  .section-heading .chevron { color: var(--primary); margin-right: 0.3rem; }

  /* No-content fallback */
  .no-content {
    text-align: center;
    color: var(--text-dim);
    font-style: italic;
    font-family: var(--font-narrative);
    font-size: 0.95rem;
    padding: 3rem 0;
  }

  /* ================= VIEW 1: PLAYER ================= */
  .view-player {
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto;
    gap: 0.75rem;
    padding: 0.75rem;
  }

  /* Hero banner — full width */
  .player-hero {
    grid-column: 1;
    grid-row: 1;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1rem 1.25rem;
  }

  .hero-top {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 0.65rem;
  }

  .hero-identity {
    flex: 1;
    min-width: 180px;
  }

  .hero-name {
    font-family: var(--font-display);
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--text);
    letter-spacing: 0.03em;
    margin-bottom: 0.1rem;
  }

  .hero-subtitle {
    font-size: 0.82rem;
    color: var(--text-secondary);
  }

  .hero-vitals {
    display: flex;
    gap: 1.25rem;
    flex-shrink: 0;
  }

  .vital-item {
    text-align: center;
  }

  .vital-label {
    font-family: var(--font-mono);
    font-size: 0.52rem;
    font-weight: 500;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 0.1rem;
  }

  .vital-value {
    font-family: var(--font-display);
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text);
    line-height: 1.1;
  }

  .vital-value.gold { color: var(--warning); }

  .hero-hp-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .hero-hp-row .hp-track { flex: 1; }

  .death-clock {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    flex-shrink: 0;
  }

  .death-clock-label {
    font-family: var(--font-mono);
    font-size: 0.55rem;
    color: var(--danger);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Stat strip — horizontal medallions */
  .player-stats {
    grid-column: 1;
    grid-row: 2;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .stat-medallion {
    flex: 1;
    min-width: 120px;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.5rem 0.6rem 0.45rem;
    position: relative;
    overflow: hidden;
  }

  .stat-medallion::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--stat-color, var(--border));
  }

  .stat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.15rem;
  }

  .stat-label {
    font-family: var(--font-mono);
    font-size: 0.58rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--stat-color, var(--text-muted));
  }

  .stat-dc {
    font-family: var(--font-mono);
    font-size: 0.55rem;
    color: var(--text-dim);
    background: var(--surface-4);
    padding: 0.05rem 0.3rem;
    border-radius: var(--radius-sm);
  }

  .stat-value {
    font-family: var(--font-display);
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--text);
    line-height: 1;
    text-align: center;
    margin: 0.1rem 0;
  }

  .stat-trained {
    border-top: 1px solid var(--border);
    margin-top: 0.35rem;
    padding-top: 0.3rem;
  }

  .stat-skill {
    font-size: 0.65rem;
    color: var(--text-secondary);
    padding: 0.06rem 0;
    display: flex;
    justify-content: space-between;
  }

  .stat-skill-name {
    color: var(--stat-color, var(--text-secondary));
  }

  .stat-skill-dc {
    font-family: var(--font-mono);
    font-size: 0.58rem;
    color: var(--text-dim);
  }

  /* Details grid — two columns below stats */
  .player-details {
    grid-column: 1;
    grid-row: 3;
    display: grid;
    grid-template-columns: 55fr 45fr;
    gap: 0.75rem;
  }

  .player-col-left,
  .player-col-right {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  /* Inventory slot pip visualization */
  .inv-slots-visual {
    display: flex;
    gap: 3px;
    flex-wrap: wrap;
    margin-bottom: 0.4rem;
  }

  .inv-slot-pip {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    background: var(--surface-1);
    border: 1px solid var(--border);
  }

  .inv-slot-pip.filled {
    background: var(--primary-soft);
    border-color: var(--primary);
  }

  /* Enhanced inventory items */
  .inv-item {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    font-size: 0.78rem;
    color: var(--text-secondary);
    padding: 0.18rem 0;
    border-bottom: 1px solid var(--border);
  }

  .inv-item:last-child { border-bottom: none; }

  .inv-item-name { flex: 1; }

  .inv-item-meta {
    font-family: var(--font-mono);
    font-size: 0.62rem;
    color: var(--text-dim);
    margin-left: 0.5rem;
    flex-shrink: 0;
  }

  /* Worn items as pill badges */
  .worn-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
    margin-top: 0.4rem;
    padding-top: 0.35rem;
    border-top: 1px solid var(--border);
  }

  .worn-pill {
    display: inline-flex;
    align-items: center;
    font-size: 0.62rem;
    font-family: var(--font-mono);
    color: var(--text-secondary);
    background: var(--surface-4);
    border: 1px solid var(--border);
    border-radius: var(--radius-pill);
    padding: 0.1rem 0.45rem;
  }

  /* Countdown die chain visualization */
  .cd-visual {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0;
  }

  .cd-name {
    font-size: 0.75rem;
    color: var(--text-secondary);
    min-width: 60px;
  }

  .cd-chain {
    display: flex;
    gap: 2px;
    align-items: center;
  }

  .cd-step {
    font-family: var(--font-mono);
    font-size: 0.55rem;
    font-weight: 500;
    padding: 0.1rem 0.25rem;
    border-radius: 3px;
    background: var(--surface-4);
    border: 1px solid var(--border);
    color: var(--text-dim);
  }

  .cd-step.current {
    color: var(--text);
    font-weight: 700;
    border-color: var(--primary);
    background: var(--primary-soft);
  }

  .cd-step.past {
    text-decoration: line-through;
    color: var(--text-dim);
    opacity: 0.5;
  }

  .cd-step.exhausted {
    color: var(--danger);
    border-color: var(--danger);
    background: var(--danger-soft);
    font-weight: 700;
  }

  /* Inventory list */
  .inv-list { list-style: none; }

  .inv-list li {
    font-size: 0.78rem;
    color: var(--text-secondary);
    padding: 0.18rem 0;
    border-bottom: 1px solid var(--border);
  }

  .inv-list li:last-child { border-bottom: none; }

  .inv-slot-count {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    color: var(--text-dim);
    margin-top: 0.35rem;
  }

  .inv-worn-label {
    font-family: var(--font-mono);
    font-size: 0.58rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 0.5rem;
    margin-bottom: 0.2rem;
    padding-top: 0.35rem;
    border-top: 1px solid var(--border);
  }

  /* Spell list */
  .spell-item {
    font-size: 0.78rem;
    color: var(--text-secondary);
    padding: 0.15rem 0;
  }

  .spell-item::before {
    content: '\2022';
    color: var(--primary);
    margin-right: 0.35rem;
  }

  /* Feature list */
  .feature-item {
    font-size: 0.78rem;
    color: var(--text-secondary);
    padding: 0.15rem 0;
  }

  .feature-item::before {
    content: '\2022';
    color: var(--text-dim);
    margin-right: 0.35rem;
  }

  /* Location card */
  .loc-name {
    font-family: var(--font-display);
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.15rem;
  }

  .loc-meta {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    color: var(--text-muted);
    margin-bottom: 0.4rem;
  }

  .loc-desc {
    font-family: var(--font-narrative);
    font-size: 0.85rem;
    font-style: italic;
    color: var(--text-secondary);
    line-height: 1.55;
  }

  /* ================= VIEW 2: GM SCREEN ================= */
  .view-gm {
    grid-template-columns: 1fr 1fr 320px;
    grid-template-rows: auto auto;
    gap: 0.75rem;
    padding: 0.75rem;
  }

  .gm-quests {
    grid-column: 1 / 3;
    grid-row: 1;
  }

  .gm-npcs {
    grid-column: 1 / 3;
    grid-row: 2;
  }

  .gm-encounter {
    grid-column: 3;
    grid-row: 1 / 3;
  }

  /* Quest cards */
  .quest-card {
    background: var(--surface-4);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.5rem 0.65rem;
    margin-bottom: 0.4rem;
    border-left: 3px solid var(--primary);
  }

  .quest-card.developing { border-left-color: var(--discord); }
  .quest-card.completed { border-left-color: var(--text-dim); }

  .quest-name {
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--text);
  }

  .quest-desc {
    font-size: 0.72rem;
    color: var(--text-secondary);
    font-style: italic;
    margin-top: 0.1rem;
  }

  .quest-progress {
    font-size: 0.68rem;
    color: var(--text-muted);
    margin-top: 0.1rem;
  }

  /* NPC grid */
  .npc-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.5rem;
  }

  .npc-card {
    background: var(--surface-4);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.55rem 0.65rem;
  }

  .npc-name {
    font-family: var(--font-display);
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.2rem;
  }

  .npc-name.deceased {
    text-decoration: line-through;
    color: var(--danger);
  }

  .npc-badges {
    display: flex;
    gap: 0.3rem;
    flex-wrap: wrap;
    margin-bottom: 0.25rem;
  }

  .npc-location {
    font-family: var(--font-mono);
    font-size: 0.62rem;
    color: var(--text-muted);
    margin-bottom: 0.2rem;
  }

  .npc-desc {
    font-size: 0.72rem;
    color: var(--text-secondary);
    line-height: 1.4;
  }

  .npc-combat {
    margin-top: 0.3rem;
    padding-top: 0.3rem;
    border-top: 1px solid var(--border);
    font-family: var(--font-mono);
    font-size: 0.6rem;
    color: var(--text-muted);
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .npc-combat .val { color: var(--text); }

  /* Encounter panel sections */
  .encounter-section {
    margin-bottom: 0.6rem;
  }

  .encounter-label {
    font-family: var(--font-display);
    font-size: 0.6rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 0.3rem;
  }

  .encounter-text {
    font-size: 0.72rem;
    color: var(--text-secondary);
    line-height: 1.45;
  }

  .dc-table {
    font-family: var(--font-mono);
    font-size: 0.65rem;
  }

  .dc-table dt {
    display: inline;
    color: var(--text-muted);
  }

  .dc-table dd {
    display: inline;
    color: var(--text);
    margin-left: 0.25rem;
    margin-right: 0.75rem;
  }

  .log-entry {
    font-size: 0.7rem;
    color: var(--text-secondary);
    padding: 0.12rem 0;
    border-bottom: 1px solid var(--border);
    line-height: 1.4;
  }

  .log-entry:last-child { border-bottom: none; }

  .thread-item {
    font-size: 0.72rem;
    color: var(--text-secondary);
    padding: 0.15rem 0;
  }

  .thread-item::before {
    content: '\203A';
    color: var(--discord);
    margin-right: 0.35rem;
    font-weight: 700;
  }

  .advance-item {
    font-size: 0.72rem;
    color: var(--text-secondary);
    padding: 0.15rem 0;
  }

  .advance-item::before {
    content: '\2022';
    color: var(--warning);
    margin-right: 0.35rem;
  }

  /* ================= VIEW 3: CAMPAIGN ================= */
  .view-campaign {
    grid-template-columns: 1fr 320px;
    grid-template-rows: auto auto auto;
    gap: 0.75rem;
    padding: 0.75rem;
  }

  .campaign-banner {
    grid-column: 1 / -1;
    grid-row: 1;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1rem 1.25rem;
  }

  .campaign-title {
    font-family: var(--font-display);
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--text);
    letter-spacing: 0.04em;
    margin-bottom: 0.15rem;
  }

  .campaign-subtitle {
    font-family: var(--font-narrative);
    font-size: 0.9rem;
    font-style: italic;
    color: var(--text-muted);
    margin-bottom: 0.3rem;
  }

  .campaign-meta {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    color: var(--text-dim);
  }

  .campaign-quests {
    grid-column: 1;
    grid-row: 2;
  }

  .campaign-timeline {
    grid-column: 1;
    grid-row: 3;
  }

  .campaign-right-top {
    grid-column: 2;
    grid-row: 2;
  }

  .campaign-right-bottom {
    grid-column: 2;
    grid-row: 3;
  }

  /* Faction cards */
  .faction-card {
    background: var(--surface-4);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.5rem 0.65rem;
    margin-bottom: 0.4rem;
  }

  .faction-name {
    font-family: var(--font-display);
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.15rem;
  }

  .faction-goals {
    font-size: 0.7rem;
    color: var(--text-secondary);
    font-style: italic;
  }

  /* Session timeline */
  .timeline-session {
    margin-bottom: 0.65rem;
  }

  .timeline-label {
    font-family: var(--font-display);
    font-size: 0.68rem;
    font-weight: 600;
    color: var(--text);
    letter-spacing: 0.04em;
    padding-bottom: 0.2rem;
    border-bottom: 1px solid var(--border);
    margin-bottom: 0.25rem;
  }

  .timeline-entry {
    font-size: 0.72rem;
    color: var(--text-secondary);
    padding: 0.1rem 0 0.1rem 0.5rem;
    border-left: 1px solid var(--border);
    margin-left: 0.25rem;
  }

  /* World state summary */
  .world-state-text {
    font-family: var(--font-narrative);
    font-size: 0.88rem;
    font-style: italic;
    color: var(--text-secondary);
    line-height: 1.6;
  }

  /* ================= VIEW 4: STORY & AUDIO ================= */
  .view-media {
    grid-template-columns: 260px 1fr;
    grid-template-rows: 1fr auto;
    gap: 0;
  }

  .media-list {
    grid-column: 1;
    grid-row: 1;
    background: var(--surface-1);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 0.5rem 0;
  }

  .chapter-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.55rem 0.75rem;
    font-size: 0.78rem;
    color: var(--text-muted);
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-family: var(--font-body);
    transition: color 0.15s, background 0.15s;
  }

  .chapter-item:hover {
    color: var(--text-secondary);
    background: var(--surface-2);
  }

  .chapter-item.active {
    color: var(--text);
    background: var(--surface-2);
  }

  .chapter-item .ch-num {
    font-family: var(--font-mono);
    font-size: 0.6rem;
    color: var(--text-dim);
    flex-shrink: 0;
  }

  .chapter-item .ch-title {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .chapter-item .ch-audio {
    font-size: 0.75rem;
    flex-shrink: 0;
    opacity: 0.5;
  }

  /* Audio player at bottom of list */
  .media-player {
    grid-column: 1;
    grid-row: 2;
    background: var(--surface-2);
    border-right: 1px solid var(--border);
    border-top: 1px solid var(--border);
    padding: 0.6rem 0.75rem;
  }

  .player-title {
    font-size: 0.68rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 0.35rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .media-player audio {
    width: 100%;
    height: 32px;
    border-radius: var(--radius-sm);
    outline: none;
  }

  audio::-webkit-media-controls-panel { background: var(--surface-1); }
  audio::-webkit-media-controls-current-time-display,
  audio::-webkit-media-controls-time-remaining-display {
    color: var(--text-muted);
    font-size: 0.65rem;
  }

  /* Reader pane */
  .media-reader {
    grid-column: 2;
    grid-row: 1 / 3;
    overflow-y: auto;
    padding: 2rem 3rem;
  }

  .chapter-prose {
    max-width: 640px;
    margin: 0 auto;
    font-family: var(--font-narrative);
    font-size: 1.05rem;
    font-weight: 300;
    line-height: 1.75;
    color: var(--text-secondary);
  }

  .chapter-prose h1 {
    font-family: var(--font-display);
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 0.5rem;
    letter-spacing: 0.04em;
  }

  .chapter-prose hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 1.8rem auto;
    width: 40%;
  }

  .chapter-prose p {
    margin-bottom: 1rem;
    text-indent: 1.5em;
  }

  .chapter-prose p:first-of-type,
  .chapter-prose hr + p { text-indent: 0; }

  .chapter-prose em { color: var(--text-muted); }

  .chapter-prose .epigraph {
    text-align: center;
    font-style: italic;
    color: var(--text-muted);
    margin: 1.5rem 0;
    text-indent: 0;
  }

  /* ================= RESPONSIVE ================= */
  @media (max-width: 900px) {
    body {
      grid-template-columns: 1fr;
      grid-template-rows: var(--header-height) auto 1fr;
    }

    .sidebar {
      grid-row: 2;
      grid-column: 1;
      flex-direction: row;
      border-right: none;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
    }

    .sidebar-minicard { display: none; }
    .sidebar-footer { display: none; }

    .sidebar-nav {
      display: flex;
      padding: 0;
      flex: none;
    }

    .nav-label { display: none; }

    .nav-item {
      border-left: none;
      border-bottom: 2px solid transparent;
      padding: 0.45rem 0.75rem;
      white-space: nowrap;
    }

    .nav-item.active { border-bottom-color: var(--primary); }

    .content {
      grid-column: 1;
      grid-row: 3;
    }

    .stat-medallion { min-width: calc(33.3% - 0.5rem); }

    .player-details { grid-template-columns: 1fr; }

    .view-gm {
      grid-template-columns: 1fr;
      grid-template-rows: auto auto auto;
    }

    .gm-quests { grid-column: 1; grid-row: 1; }
    .gm-npcs { grid-column: 1; grid-row: 2; }
    .gm-encounter { grid-column: 1; grid-row: 3; }

    .view-campaign {
      grid-template-columns: 1fr;
      grid-template-rows: auto auto auto auto auto;
    }

    .campaign-banner { grid-column: 1; }
    .campaign-quests { grid-column: 1; grid-row: 2; }
    .campaign-right-top { grid-column: 1; grid-row: 3; }
    .campaign-timeline { grid-column: 1; grid-row: 4; }
    .campaign-right-bottom { grid-column: 1; grid-row: 5; }

    .view-media {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr auto;
    }

    .media-list {
      grid-column: 1;
      grid-row: 1;
      max-height: 120px;
      border-right: none;
      border-bottom: 1px solid var(--border);
    }

    .media-reader { grid-column: 1; grid-row: 2; padding: 1.5rem 1rem; }
    .media-player { grid-column: 1; grid-row: 3; border-right: none; }
  }

  @media (max-width: 600px) {
    .header-brand { font-size: 0.72rem; }
    .header-title { font-size: 0.7rem; }
    .header-meta { display: none; }

    .stat-medallion { min-width: calc(50% - 0.5rem); }

    .hero-vitals { flex-wrap: wrap; gap: 0.75rem; }

    .media-reader { padding: 1rem; }
  }
</style>
</head>
<body>

<!-- ================= HEADER ================= -->
<div class="header">
  <span class="header-brand">Glintlock</span>
  <span class="header-title" id="header-title"></span>
  <span class="header-meta" id="header-meta"></span>
</div>

<!-- ================= SIDEBAR ================= -->
<div class="sidebar">
  <div class="sidebar-minicard" id="sidebar-minicard"></div>
  <div class="sidebar-nav">
    <div class="nav-label">Dashboards</div>
    <button class="nav-item active" data-view="player" onclick="switchView('player')">
      <span class="nav-icon">&#9876;</span> Character
    </button>
    <button class="nav-item" data-view="gm" onclick="switchView('gm')">
      <span class="nav-icon">&#9881;</span> GM Screen
    </button>
    <button class="nav-item" data-view="campaign" onclick="switchView('campaign')">
      <span class="nav-icon">&#9734;</span> Campaign
    </button>
    <button class="nav-item" data-view="media" onclick="switchView('media')">
      <span class="nav-icon">&#9836;</span> Story & Audio
    </button>
  </div>
  <div class="sidebar-footer" id="sidebar-footer"></div>
</div>

<!-- ================= CONTENT ================= -->
<div class="content">
  <div class="view view-player active" id="view-player"></div>
  <div class="view view-gm" id="view-gm"></div>
  <div class="view view-campaign" id="view-campaign"></div>
  <div class="view view-media" id="view-media"></div>
</div>

<script>
const DATA = DASHBOARD_DATA;

/* ==================== Utilities ==================== */
function difficulty(stat, trained) {
  return trained ? Math.max(1, 20 - stat * 2) : Math.max(1, 20 - stat);
}

function esc(s) {
  if (s == null) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

function hpBar(cur, max, cls) {
  const pct = Math.max(0, Math.min(100, (cur / Math.max(max, 1)) * 100));
  const low = pct <= 35;
  const track = cls || 'hp-track';
  return '<div class="' + track + '"><div class="hp-fill' + (low ? ' low' : '') + '" style="width:' + pct + '%"></div>' +
    (cls ? '' : '<div class="hp-text">HP ' + cur + ' / ' + max + '</div>') + '</div>';
}

function pillBadge(text, cls) {
  return '<span class="pill ' + cls + '">' + (cls.indexOf('pill-alive') >= 0 || cls.indexOf('pill-deceased') >= 0 ? '<span class="pill-dot"></span>' : '') + esc(text) + '</span>';
}

function dispositionPill(d) {
  const map = { friendly: 'pill-friendly', wary: 'pill-wary', hostile: 'pill-hostile', neutral: 'pill-neutral' };
  return pillBadge(d, map[d] || 'pill-neutral');
}

function tagSpan(tag) {
  const tc = { event: 'tag-event', discovery: 'tag-discovery', ruling: 'tag-ruling', thread: 'tag-thread', 'world-advance': 'tag-world-advance' };
  return '<span class="tag ' + (tc[tag] || 'tag-event') + '">' + tag + '</span>';
}

function md2html(text) {
  if (!text) return '';
  let html = text.replace(/\n---\n/g, '<hr>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  html = html.replace(/^\*([^*]+)\*$/gm, '<p class="epigraph"><em>$1</em></p>');
  html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
  const parts = html.split(/\n\n+/);
  return parts.map(p => {
    p = p.trim();
    if (!p) return '';
    if (p.startsWith('<h1>') || p.startsWith('<hr') || p.startsWith('<p class="epigraph">')) return p;
    return '<p>' + p + '</p>';
  }).join('\n');
}

/* Portent level to CSS class */
function portentClass(level) {
  if (level <= 1) return 'low';
  if (level <= 3) return 'mid';
  if (level <= 5) return 'high';
  return 'crit';
}

/* Countdown die CSS class */
function cdClass(die) {
  if (die === 0) return 'cd-dead';
  if (die <= 4) return 'cd-danger';
  if (die <= 6) return 'cd-warn';
  return 'cd-ok';
}

/* Draw a progress clock SVG */
function clockSvg(filled, total, size) {
  size = size || 32;
  const r = size / 2 - 2;
  const cx = size / 2;
  const cy = size / 2;
  let svg = '<svg class="clock-svg" width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '">';
  svg += '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="var(--surface-1)" stroke="var(--border)" stroke-width="1.5"/>';
  for (let i = 0; i < total; i++) {
    const startAngle = (i / total) * 2 * Math.PI - Math.PI / 2;
    const endAngle = ((i + 1) / total) * 2 * Math.PI - Math.PI / 2;
    const x1 = cx + r * Math.cos(startAngle);
    const y1 = cy + r * Math.sin(startAngle);
    const x2 = cx + r * Math.cos(endAngle);
    const y2 = cy + r * Math.sin(endAngle);
    const largeArc = (endAngle - startAngle > Math.PI) ? 1 : 0;
    if (i < filled) {
      svg += '<path d="M' + cx + ',' + cy + ' L' + x1 + ',' + y1 + ' A' + r + ',' + r + ' 0 ' + largeArc + ',1 ' + x2 + ',' + y2 + ' Z" fill="var(--primary)" opacity="0.85"/>';
    }
    /* Segment line */
    svg += '<line x1="' + cx + '" y1="' + cy + '" x2="' + x1 + '" y2="' + y1 + '" stroke="var(--border)" stroke-width="1"/>';
  }
  svg += '</svg>';
  return svg;
}

/* Parse journal entries into session groups */
function parseJournal(journal) {
  const groups = [];
  let current = { label: 'Journal', entries: [] };
  (journal || []).forEach(e => {
    const str = typeof e === 'string' ? e : '';
    const m = str.match(/^##?\s*Session\s+(\d+)/);
    if (m) {
      if (current.entries.length) groups.push(current);
      current = { label: 'Session ' + m[1], entries: [] };
      return;
    }
    if (str.trim() && !str.match(/^#/)) current.entries.push(str);
  });
  if (current.entries.length) groups.push(current);
  return groups;
}

/* ==================== View switching ==================== */
const viewTitles = { player: 'Character Sheet', gm: 'GM Screen', campaign: 'Campaign Overview', media: 'Story & Audio' };

function switchView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const target = document.getElementById('view-' + name);
  if (target) target.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const btn = document.querySelector('.nav-item[data-view="' + name + '"]');
  if (btn) btn.classList.add('active');
  document.getElementById('header-title').textContent = viewTitles[name] || '';
}

/* ==================== Sub-tab switching ==================== */
function switchSubTab(groupId, tabName) {
  const group = document.getElementById(groupId);
  if (!group) return;
  group.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
  group.querySelectorAll('.sub-pane').forEach(p => p.classList.remove('active'));
  const tab = group.querySelector('.sub-tab[data-tab="' + tabName + '"]');
  const pane = group.querySelector('.sub-pane[data-pane="' + tabName + '"]');
  if (tab) tab.classList.add('active');
  if (pane) pane.classList.add('active');
}

/* ==================== Render: Header ==================== */
function renderHeader() {
  const meta = DATA.session_metadata || {};
  const parts = [];
  if (meta.sessions_played) parts.push(meta.sessions_played + ' sessions');
  if (meta.last_played) parts.push(meta.last_played);
  document.getElementById('header-meta').textContent = parts.join(' \u00b7 ');
  document.getElementById('header-title').textContent = viewTitles[DATA.dashboard_type || 'player'] || 'Character Sheet';
}

/* ==================== Render: Sidebar ==================== */
function renderSidebar() {
  const c = DATA.character;
  const mc = document.getElementById('sidebar-minicard');
  if (!c) { mc.innerHTML = ''; return; }

  const hpCur = c.hp ? c.hp.current : 0;
  const hpMax = c.hp ? c.hp.max : 1;
  const hpPct = Math.max(0, Math.min(100, (hpCur / Math.max(hpMax, 1)) * 100));

  let h = '<div class="mini-name">' + esc(c.name) + '</div>';
  h += '<div class="mini-subtitle">' + esc((c.ancestry || '') + ' ' + (c.class || '') + ' ' + (c.level || 1)) + '</div>';
  h += '<div class="mini-hp-track"><div class="mini-hp-fill' + (hpPct <= 35 ? ' low' : '') + '" style="width:' + hpPct + '%"></div>';
  h += '<div class="mini-hp-text">HP ' + hpCur + '/' + hpMax + '</div></div>';
  h += '<div class="mini-stats">';
  h += '<span>Armor <span class="val">' + (c.armor || 0) + '</span></span>';
  h += '<span class="gold">Gold <span class="val">' + (c.gold || 0) + '</span></span>';
  h += '</div>';
  mc.innerHTML = h;

  /* Footer */
  const foot = document.getElementById('sidebar-footer');
  const loc = DATA.location;
  let fh = '';
  if (loc) {
    const dcls = 'danger-' + (loc.danger_level || 'safe');
    fh += '<div class="footer-location"><span class="loc-icon">&#9679;</span> ' + esc(loc.name);
    fh += ' <span class="danger-badge ' + dcls + '">' + esc(loc.danger_level || 'safe') + '</span></div>';
  }
  /* Level indicator (milestone advancement) */
  const lvl = c.level || 1;
  fh += '<div class="level-label">Level ' + lvl + ' / 10</div>';
  foot.innerHTML = fh;
}

/* ==================== Player View Helpers ==================== */
const SKILL_STAT_MAP = {
  'Athletics': 'vigor', 'Endurance': 'vigor',
  'Acrobatics': 'reflex', 'Stealth': 'reflex', 'Sleight': 'reflex',
  'Awareness': 'wits', 'Survival': 'wits', 'Tinker': 'wits',
  'Fortitude': 'resolve', 'Commune': 'resolve',
  'Persuasion': 'presence', 'Deception': 'presence',
  'Arcana': 'lore', 'Medicine': 'lore', 'History': 'lore'
};

const STAT_COLORS = {
  vigor: 'var(--stat-vigor)', reflex: 'var(--stat-reflex)', wits: 'var(--stat-wits)',
  resolve: 'var(--stat-resolve)', presence: 'var(--stat-presence)', lore: 'var(--stat-lore)'
};

function cdChainHtml(currentDie) {
  const steps = [12, 10, 8, 6, 4, 0];
  let html = '<div class="cd-chain">';
  steps.forEach(s => {
    const label = s === 0 ? 'OUT' : 'd' + s;
    let cls = 'cd-step';
    if (currentDie === s) {
      cls += s === 0 ? ' exhausted' : ' current';
    } else if (s > currentDie) {
      cls += ' past';
    }
    html += '<span class="' + cls + '">' + label + '</span>';
  });
  html += '</div>';
  return html;
}

function slotPipsHtml(used, max) {
  let html = '<div class="inv-slots-visual">';
  for (let i = 0; i < max; i++) {
    html += '<div class="inv-slot-pip' + (i < used ? ' filled' : '') + '"></div>';
  }
  html += '</div>';
  return html;
}

/* ==================== Render: Player View ==================== */
function renderPlayer() {
  const c = DATA.character;
  const el = document.getElementById('view-player');
  if (!c) { el.innerHTML = '<div class="no-content">No character data.</div>'; return; }

  const hpCur = c.hp ? c.hp.current : 0;
  const hpMax = c.hp ? c.hp.max : 1;
  const stats = c.stats || {};
  const statNames = ['vigor', 'reflex', 'wits', 'resolve', 'presence', 'lore'];
  const statLabels = { vigor: 'VIG', reflex: 'REF', wits: 'WIT', resolve: 'RES', presence: 'PRE', lore: 'LOR' };
  const training = c.training || [];

  /* Build skill→stat lookup for trained skills only */
  const trainedBystat = {};
  statNames.forEach(s => { trainedBystat[s] = []; });
  training.forEach(sk => {
    const mapped = SKILL_STAT_MAP[sk];
    if (mapped && trainedBystat[mapped]) {
      trainedBystat[mapped].push(sk);
    }
  });

  let html = '';

  /* ===== Hero Banner ===== */
  html += '<div class="player-hero">';
  html += '<div class="hero-top">';
  html += '<div class="hero-identity">';
  html += '<div class="hero-name">' + esc(c.name) + '</div>';
  html += '<div class="hero-subtitle">' + esc((c.ancestry || '') + ' ' + (c.class || '') + ' ' + (c.level || 1));
  if (c.background) html += ' \u00b7 ' + esc(c.background);
  html += '</div></div>';
  html += '<div class="hero-vitals">';
  html += '<div class="vital-item"><div class="vital-label">Armor</div><div class="vital-value">' + (c.armor || 0) + '</div></div>';
  if (c.hp_die) html += '<div class="vital-item"><div class="vital-label">HP Die</div><div class="vital-value">' + esc(c.hp_die) + '</div></div>';
  html += '<div class="vital-item"><div class="vital-label">Level</div><div class="vital-value">' + (c.level || 1) + '</div></div>';
  html += '<div class="vital-item"><div class="vital-label">Gold</div><div class="vital-value gold">' + (c.gold || 0) + '</div></div>';
  html += '</div></div>';
  /* HP bar row + optional death clock */
  html += '<div class="hero-hp-row">';
  html += hpBar(hpCur, hpMax);
  const deathClock = c.death_clock || 0;
  if (deathClock > 0) {
    html += '<div class="death-clock">';
    html += clockSvg(deathClock, 4, 28);
    html += '<span class="death-clock-label">Death</span>';
    html += '</div>';
  }
  html += '</div></div>';

  /* ===== Stat Strip ===== */
  html += '<div class="player-stats">';
  statNames.forEach(s => {
    const val = stats[s] || 5;
    const dc = difficulty(val, false);
    const color = STAT_COLORS[s];
    const skills = trainedBystat[s] || [];
    html += '<div class="stat-medallion" style="--stat-color:' + color + '">';
    html += '<div class="stat-header"><span class="stat-label">' + statLabels[s] + '</span><span class="stat-dc">DC ' + dc + '</span></div>';
    html += '<div class="stat-value">' + val + '</div>';
    if (skills.length) {
      html += '<div class="stat-trained">';
      skills.forEach(sk => {
        const trainedDc = difficulty(val, true);
        html += '<div class="stat-skill"><span class="stat-skill-name">' + esc(sk) + '</span><span class="stat-skill-dc">DC ' + trainedDc + '</span></div>';
      });
      html += '</div>';
    }
    html += '</div>';
  });
  html += '</div>';

  /* ===== Details Grid ===== */
  html += '<div class="player-details">';

  /* — Left Column — */
  html += '<div class="player-col-left">';

  /* Inventory */
  html += '<div class="card"><div class="card-header"><span class="chevron">&rsaquo;</span> Inventory</div><div class="card-body">';
  const used = c.used_gear_slots || (c.inventory ? c.inventory.length : 0);
  const max = c.max_gear_slots || 10;
  html += slotPipsHtml(used, max);
  html += '<div style="font-family:var(--font-mono);font-size:0.58rem;color:var(--text-dim);margin-bottom:0.4rem">' + used + '/' + max + ' slots</div>';
  if (c.inventory && c.inventory.length) {
    c.inventory.forEach(i => {
      const item = typeof i === 'string' ? i : (i.name || '');
      const meta = typeof i === 'object' ? (i.qty || i.notes || '') : '';
      html += '<div class="inv-item"><span class="inv-item-name">' + esc(item) + '</span>';
      if (meta) html += '<span class="inv-item-meta">' + esc(meta) + '</span>';
      html += '</div>';
    });
  } else {
    html += '<div style="color:var(--text-dim);font-style:italic;font-size:0.78rem">Empty</div>';
  }
  const worn = c.worn || [];
  if (worn.length) {
    html += '<div class="worn-pills">';
    worn.forEach(w => { html += '<span class="worn-pill">' + esc(w) + '</span>'; });
    html += '</div>';
  }
  html += '</div></div>';

  /* Countdown dice */
  const cdice = DATA.countdown_dice || [];
  if (cdice.length) {
    html += '<div class="card"><div class="card-header"><span class="chevron">&rsaquo;</span> Countdown Dice</div><div class="card-body">';
    cdice.forEach(function(cd) {
      html += '<div class="cd-visual">';
      html += '<span class="cd-name">' + esc(cd.name);
      if (cd.category) html += ' <span style="color:var(--text-dim);font-size:0.58rem">(' + esc(cd.category) + ')</span>';
      html += '</span>';
      html += cdChainHtml(cd.current_die);
      html += '</div>';
    });
    html += '</div></div>';
  }

  /* Training & languages */
  const langs = c.languages || [];
  if (training.length || langs.length) {
    html += '<div class="card"><div class="card-header"><span class="chevron">&rsaquo;</span> Training & Languages</div><div class="card-body">';
    if (training.length) html += '<div style="font-size:0.72rem;color:var(--text-secondary);margin-bottom:0.3rem">' + esc(training.join(', ')) + '</div>';
    if (langs.length) html += '<div style="font-size:0.72rem;color:var(--text-secondary)"><span style="color:var(--text-muted)">Languages:</span> ' + esc(langs.join(', ')) + '</div>';
    html += '</div></div>';
  }

  html += '</div>';

  /* — Right Column — */
  html += '<div class="player-col-right">';

  /* Location */
  const loc = DATA.location;
  if (loc) {
    html += '<div class="card"><div class="card-header"><span class="chevron">&rsaquo;</span> Location</div><div class="card-body">';
    html += '<div class="loc-name">' + esc(loc.name) + '</div>';
    const dcls = 'danger-' + (loc.danger_level || 'safe');
    html += '<div class="loc-meta"><span class="danger-badge ' + dcls + '">' + esc(loc.danger_level || 'safe') + '</span>';
    if (loc.light) html += ' \u00b7 ' + esc(loc.light);
    html += '</div>';
    if (loc.description) html += '<div class="loc-desc">' + esc(loc.description) + '</div>';
    html += '</div></div>';
  }

  /* Tabbed Features & Talents */
  const classFeatures = c.class_features || [];
  const ancestryTraits = c.ancestry_traits || [];
  const talents = c.talents || [];
  if (classFeatures.length || ancestryTraits.length || talents.length) {
    html += '<div class="card" id="player-feat-card">';
    html += '<div class="sub-tabs">';
    html += '<button class="sub-tab active" data-tab="pclass" onclick="switchSubTab(\'player-feat-card\',\'pclass\')">Class</button>';
    html += '<button class="sub-tab" data-tab="pancestry" onclick="switchSubTab(\'player-feat-card\',\'pancestry\')">Ancestry</button>';
    if (talents.length) html += '<button class="sub-tab" data-tab="ptalents" onclick="switchSubTab(\'player-feat-card\',\'ptalents\')">Talents</button>';
    html += '</div>';
    html += '<div class="card-body">';
    html += '<div class="sub-pane active" data-pane="pclass">';
    if (classFeatures.length) { classFeatures.forEach(f => { html += '<div class="feature-item">' + esc(f) + '</div>'; }); }
    else { html += '<div style="color:var(--text-dim);font-style:italic;font-size:0.78rem">None</div>'; }
    html += '</div>';
    html += '<div class="sub-pane" data-pane="pancestry">';
    if (ancestryTraits.length) { ancestryTraits.forEach(f => { html += '<div class="feature-item">' + esc(f) + '</div>'; }); }
    else { html += '<div style="color:var(--text-dim);font-style:italic;font-size:0.78rem">None</div>'; }
    html += '</div>';
    if (talents.length) {
      html += '<div class="sub-pane" data-pane="ptalents">';
      talents.forEach(t => { html += '<div class="feature-item">' + esc(t) + '</div>'; });
      html += '</div>';
    }
    html += '</div></div>';
  }

  /* Spells */
  const spells = c.spells || [];
  if (spells.length) {
    html += '<div class="card"><div class="card-header"><span class="chevron">&rsaquo;</span> Spells</div><div class="card-body">';
    spells.forEach(s => { html += '<div class="spell-item">' + esc(s) + '</div>'; });
    html += '</div></div>';
  }

  html += '</div>';

  html += '</div>';

  el.innerHTML = html;
}

/* ==================== Render: GM View ==================== */
function renderGM() {
  const el = document.getElementById('view-gm');
  let html = '';

  /* Quests/Threads tabbed card */
  html += '<div class="gm-quests"><div class="card" id="gm-qt-card">';
  html += '<div class="sub-tabs">';
  html += '<button class="sub-tab active" data-tab="quests" onclick="switchSubTab(\'gm-qt-card\',\'quests\')">Active Quests</button>';
  html += '<button class="sub-tab" data-tab="threads" onclick="switchSubTab(\'gm-qt-card\',\'threads\')">Threads</button>';
  html += '</div>';
  html += '<div class="card-body">';

  /* Quests pane */
  html += '<div class="sub-pane active" data-pane="quests">';
  const q = DATA.quests;
  if (q) {
    (q.active || []).forEach(i => {
      const name = typeof i === 'string' ? i : (i.name || i);
      const desc = typeof i === 'object' ? i.desc : null;
      html += '<div class="quest-card"><div class="quest-name">' + esc(name) + '</div>';
      if (desc) html += '<div class="quest-desc">' + esc(desc) + '</div>';
      html += '</div>';
    });
    (q.developing || []).forEach(i => {
      const name = typeof i === 'string' ? i : (i.name || i);
      const desc = typeof i === 'object' ? i.desc : null;
      html += '<div class="quest-card developing"><div class="quest-name">' + esc(name) + '</div>';
      if (desc) html += '<div class="quest-desc">' + esc(desc) + '</div>';
      html += '</div>';
    });
    if (!(q.active || []).length && !(q.developing || []).length) {
      html += '<div style="color:var(--text-dim);font-style:italic;font-size:0.78rem">No active quests</div>';
    }
  } else {
    html += '<div style="color:var(--text-dim);font-style:italic;font-size:0.78rem">No quest data</div>';
  }
  html += '</div>';

  /* Threads pane */
  html += '<div class="sub-pane" data-pane="threads">';
  const threads = DATA.open_threads || [];
  if (threads.length) {
    threads.forEach(t => {
      const text = typeof t === 'string' ? t : (t.text || t.name || '');
      html += '<div class="thread-item">' + esc(text) + '</div>';
    });
  } else {
    html += '<div style="color:var(--text-dim);font-style:italic;font-size:0.78rem">No open threads</div>';
  }
  html += '</div>';

  html += '</div></div></div>';

  /* NPC grid */
  html += '<div class="gm-npcs"><div class="card"><div class="card-header"><span class="chevron">&rsaquo;</span> NPC Quick Reference</div>';
  html += '<div class="card-body">';
  const npcs = DATA.npcs || [];
  if (npcs.length) {
    html += '<div class="npc-grid">';
    npcs.forEach(n => {
      const dead = (n.status || 'alive') === 'deceased';
      html += '<div class="npc-card">';
      html += '<div class="npc-name' + (dead ? ' deceased' : '') + '">' + esc(n.name) + '</div>';
      html += '<div class="npc-badges">';
      html += pillBadge(dead ? 'deceased' : 'alive', dead ? 'pill-deceased' : 'pill-alive');
      if (n.disposition) html += dispositionPill(n.disposition);
      html += '</div>';
      if (n.location) html += '<div class="npc-location">' + esc(n.location) + '</div>';
      if (n.description) html += '<div class="npc-desc">' + esc(n.description) + '</div>';
      /* Combat stats if available */
      if (n.hp || n.armor || n.attack_die) {
        html += '<div class="npc-combat">';
        if (n.hp) html += '<span>HP <span class="val">' + (typeof n.hp === 'object' ? n.hp.current + '/' + n.hp.max : n.hp) + '</span></span>';
        if (n.armor) html += '<span>Armor <span class="val">' + n.armor + '</span></span>';
        if (n.attack_die) html += '<span>Atk <span class="val">' + esc(n.attack_die) + '</span></span>';
        if (n.zone) html += '<span>Zone <span class="val">' + esc(n.zone) + '</span></span>';
        if (n.morale) html += '<span>ML <span class="val">' + n.morale + '</span></span>';
        html += '</div>';
      }
      html += '</div>';
    });
    html += '</div>';
  } else {
    html += '<div style="color:var(--text-dim);font-style:italic;font-size:0.78rem">No known NPCs</div>';
  }
  html += '</div></div></div>';

  /* Encounter / reference panel */
  html += '<div class="gm-encounter"><div class="card"><div class="card-header"><span class="chevron">&rsaquo;</span> Session Tools</div>';
  html += '<div class="card-body">';

  /* Session info */
  const meta = DATA.session_metadata || {};
  html += '<div class="encounter-section">';
  html += '<div class="encounter-label">Session</div>';
  html += '<div class="encounter-text">';
  if (meta.sessions_played) html += 'Session ' + meta.sessions_played;
  if (meta.last_played) html += ' \u00b7 ' + esc(meta.last_played);
  html += '</div></div>';

  /* Recent log entries */
  const journal = DATA.journal || [];
  const recentEntries = journal.filter(e => typeof e === 'string' && e.trim() && !e.match(/^##?\s/) && !e.match(/^#/)).slice(-5);
  if (recentEntries.length) {
    html += '<div class="encounter-section">';
    html += '<div class="encounter-label">Recent Events</div>';
    recentEntries.forEach(e => {
      const m = e.match(/\[(\w[\w-]*)\]/);
      const tag = m ? m[1] : null;
      const text = e.replace(/\[[\w-]+\]\s*/, '').replace(/^-\s*/, '');
      html += '<div class="log-entry">' + (tag ? tagSpan(tag) : '') + esc(text) + '</div>';
    });
    html += '</div>';
  }

  /* GM Notes */
  const prep = DATA.gm_notes;
  if (prep) {
    html += '<div class="encounter-section">';
    html += '<div class="encounter-label">GM Notes</div>';
    if (prep.strong_start) html += '<div class="encounter-text" style="margin-bottom:0.3rem"><strong style="color:var(--text-muted)">Start:</strong> ' + esc(prep.strong_start) + '</div>';
    if (prep.secrets && prep.secrets.length) {
      html += '<div class="encounter-text" style="margin-bottom:0.3rem"><strong style="color:var(--text-muted)">Secrets:</strong> ' + esc(prep.secrets.slice(0, 3).join('; ')) + '</div>';
    }
    if (prep.npcs_to_use && prep.npcs_to_use.length) {
      html += '<div class="encounter-text"><strong style="color:var(--text-muted)">NPCs:</strong> ' + esc(prep.npcs_to_use.join(', ')) + '</div>';
    }
    html += '</div>';
  }

  /* Quick reference */
  html += '<div class="encounter-section">';
  html += '<div class="encounter-label">Quick Reference</div>';
  html += '<div class="encounter-text" style="font-size:0.65rem;color:var(--text-dim)">Difficulty = 20 \u2212 Stat (untrained)<br>Difficulty = 20 \u2212 Stat\u00d72 (trained)<br>Critical: beat DC by 5+<br>Death Clock: 4 segments, 1/turn</div>';
  html += '</div>';

  /* World advances */
  const advances = DATA.world_advances || [];
  if (advances.length) {
    html += '<div class="encounter-section">';
    html += '<div class="encounter-label">World Advances</div>';
    advances.forEach(a => {
      const text = typeof a === 'string' ? a : (a.text || '');
      html += '<div class="advance-item">' + esc(text.replace(/\[world-advance\]\s*/i, '').replace(/^-\s*/, '')) + '</div>';
    });
    html += '</div>';
  }

  /* Doom portent tracks */
  const dooms = DATA.dooms || [];
  if (dooms.length) {
    html += '<div class="encounter-section">';
    html += '<div class="encounter-label">Doom Portents</div>';
    dooms.forEach(function(m) {
      const pct = Math.max(0, Math.min(100, (m.portent_level / 6) * 100));
      html += '<div class="doom-item">';
      html += '<div class="doom-name">' + esc(m.name) + '</div>';
      html += '<div class="portent-track"><div class="portent-fill ' + portentClass(m.portent_level) + '" style="width:' + pct + '%"></div></div>';
      html += '<div class="doom-portent-label">Portent ' + m.portent_level + '/6' + (m.current_portent ? ' \u2014 ' + esc(m.current_portent) : '') + '</div>';
      html += '</div>';
    });
    html += '</div>';
  }

  /* Progress clocks */
  const clocks = DATA.clocks || [];
  if (clocks.length) {
    html += '<div class="encounter-section">';
    html += '<div class="encounter-label">Progress Clocks</div>';
    clocks.forEach(function(cl) {
      html += '<div class="clock-row">';
      html += clockSvg(cl.segments_filled, cl.total_segments);
      html += '<div><div class="clock-label">' + esc(cl.name) + '</div>';
      html += '<div class="clock-meta">' + cl.segments_filled + '/' + cl.total_segments;
      if (cl.trigger) html += ' \u2014 ' + esc(cl.trigger);
      html += '</div></div></div>';
    });
    html += '</div>';
  }

  html += '</div></div></div>';

  el.innerHTML = html;
}

/* ==================== Render: Campaign View ==================== */
function renderCampaign() {
  const el = document.getElementById('view-campaign');
  let html = '';

  /* Banner */
  const ctx = DATA.campaign_context || {};
  const mem = DATA.campaign_memory || {};
  const meta = DATA.session_metadata || {};

  html += '<div class="campaign-banner">';
  html += '<div class="campaign-title">' + esc(ctx.name || ctx.setting || 'Campaign') + '</div>';
  if (ctx.tone || ctx.premise) html += '<div class="campaign-subtitle">"' + esc(ctx.tone || ctx.premise) + '"</div>';
  const bannerParts = [];
  if (meta.sessions_played) bannerParts.push(meta.sessions_played + ' sessions');
  if (meta.first_played) bannerParts.push('Started ' + meta.first_played);
  else if (meta.last_played) bannerParts.push('Last played ' + meta.last_played);
  if (bannerParts.length) html += '<div class="campaign-meta">' + esc(bannerParts.join(' \u00b7 ')) + '</div>';
  html += '</div>';

  /* Quest tracker */
  html += '<div class="campaign-quests"><div class="card"><div class="card-header"><span class="chevron">&rsaquo;</span> Quest Progress</div>';
  html += '<div class="card-body">';
  const q = DATA.quests;
  if (q) {
    if ((q.active || []).length) {
      html += '<div class="section-heading" style="margin-top:0"><span class="chevron">&rsaquo;</span> Active (' + q.active.length + ')</div>';
      (q.active || []).forEach(i => {
        const name = typeof i === 'string' ? i : (i.name || i);
        const desc = typeof i === 'object' ? i.desc : null;
        const progress = typeof i === 'object' ? i.progress : null;
        html += '<div class="quest-card"><div class="quest-name">' + esc(name) + '</div>';
        if (desc) html += '<div class="quest-desc">' + esc(desc) + '</div>';
        if (progress) html += '<div class="quest-progress">' + esc(progress) + '</div>';
        html += '</div>';
      });
    }
    if ((q.developing || []).length) {
      html += '<div class="section-heading" style="margin-top:0.5rem"><span class="chevron" style="color:var(--discord)">&rsaquo;</span> Developing (' + q.developing.length + ')</div>';
      (q.developing || []).forEach(i => {
        const name = typeof i === 'string' ? i : (i.name || i);
        html += '<div class="quest-card developing"><div class="quest-name">' + esc(name) + '</div></div>';
      });
    }
    if ((q.completed || []).length) {
      html += '<div class="section-heading" style="margin-top:0.5rem"><span class="chevron" style="color:var(--text-dim)">&rsaquo;</span> Completed (' + q.completed.length + ')</div>';
      (q.completed || []).forEach(i => {
        const name = typeof i === 'string' ? i : (i.name || i);
        html += '<div class="quest-card completed"><div class="quest-name" style="color:var(--text-muted)">' + esc(name) + '</div></div>';
      });
    }
    if (!(q.active || []).length && !(q.developing || []).length && !(q.completed || []).length) {
      html += '<div style="color:var(--text-dim);font-style:italic;font-size:0.78rem">No quests yet</div>';
    }
  }
  html += '</div></div></div>';

  /* Session timeline */
  html += '<div class="campaign-timeline"><div class="card"><div class="card-header"><span class="chevron">&rsaquo;</span> Session Timeline</div>';
  html += '<div class="card-body">';
  const groups = parseJournal(DATA.journal);
  if (groups.length) {
    groups.slice().reverse().forEach(g => {
      html += '<div class="timeline-session">';
      html += '<div class="timeline-label">' + esc(g.label) + '</div>';
      g.entries.slice(0, 8).forEach(e => {
        const text = e.replace(/\[[\w-]+\]\s*/, '').replace(/^-\s*/, '');
        html += '<div class="timeline-entry">' + esc(text) + '</div>';
      });
      if (g.entries.length > 8) {
        html += '<div class="timeline-entry" style="color:var(--text-dim)">+ ' + (g.entries.length - 8) + ' more...</div>';
      }
      html += '</div>';
    });
  } else {
    html += '<div style="color:var(--text-dim);font-style:italic;font-size:0.78rem">No session history</div>';
  }
  html += '</div></div></div>';

  /* Factions + world state (right top) */
  html += '<div class="campaign-right-top"><div class="card"><div class="card-header"><span class="chevron">&rsaquo;</span> Factions</div>';
  html += '<div class="card-body">';
  const factions = DATA.factions || [];
  if (factions.length) {
    factions.forEach(f => {
      html += '<div class="faction-card">';
      html += '<div class="faction-name">' + esc(f.name) + '</div>';
      html += '<div class="npc-badges">';
      if (f.disposition) html += dispositionPill(f.disposition);
      if (f.members) html += '<span class="pill pill-neutral">' + f.members + ' members</span>';
      html += '</div>';
      if (f.goals) html += '<div class="faction-goals">' + esc(f.goals) + '</div>';
      html += '</div>';
    });
  } else {
    html += '<div style="color:var(--text-dim);font-style:italic;font-size:0.78rem">No factions known</div>';
  }
  html += '</div></div></div>';

  /* Active threads + world state (right bottom) */
  html += '<div class="campaign-right-bottom"><div class="card" id="camp-world-card">';
  html += '<div class="sub-tabs">';
  html += '<button class="sub-tab active" data-tab="worldstate" onclick="switchSubTab(\'camp-world-card\',\'worldstate\')">World State</button>';
  html += '<button class="sub-tab" data-tab="campthreads" onclick="switchSubTab(\'camp-world-card\',\'campthreads\')">Threads</button>';
  html += '</div>';
  html += '<div class="card-body">';

  /* World state pane */
  html += '<div class="sub-pane active" data-pane="worldstate">';
  if (mem.world_state) {
    html += '<div class="world-state-text">' + esc(mem.world_state) + '</div>';
  } else {
    html += '<div style="color:var(--text-dim);font-style:italic;font-size:0.78rem">No world state recorded</div>';
  }
  html += '</div>';

  /* Threads pane */
  html += '<div class="sub-pane" data-pane="campthreads">';
  const campThreads = (mem.active_threads || DATA.open_threads || []);
  if (campThreads.length) {
    campThreads.forEach(t => {
      const text = typeof t === 'string' ? t : (t.text || t.name || '');
      html += '<div class="thread-item">' + esc(text) + '</div>';
    });
  } else {
    html += '<div style="color:var(--text-dim);font-style:italic;font-size:0.78rem">No threads</div>';
  }
  html += '</div>';

  html += '</div></div></div>';

  el.innerHTML = html;
}

/* ==================== Render: Media View ==================== */
let currentChapter = 0;

function renderMedia() {
  const el = document.getElementById('view-media');
  const chapters = DATA.chapters || [];
  const audiobooks = DATA.audiobooks || [];

  if (!chapters.length && !audiobooks.length) {
    el.innerHTML = '<div class="media-list"></div><div class="media-reader"><div class="no-content">No chronicles written yet. Use /glintlock:chronicle to generate a chapter.</div></div><div class="media-player"></div>';
    return;
  }

  /* Build audio lookup */
  const audioMap = {};
  audiobooks.forEach(ab => { audioMap[ab.chapter] = ab; });

  /* Chapter list */
  let html = '<div class="media-list">';
  chapters.forEach((ch, i) => {
    const hasAudio = !!audioMap[ch.number];
    html += '<button class="chapter-item' + (i === 0 ? ' active' : '') + '" data-idx="' + i + '" onclick="selectChapter(' + i + ')">';
    html += '<span class="ch-num">Ch ' + ch.number + '</span>';
    html += '<span class="ch-title">' + esc(ch.title) + '</span>';
    if (hasAudio) html += '<span class="ch-audio">&#9835;</span>';
    html += '</button>';
  });
  html += '</div>';

  /* Audio player */
  html += '<div class="media-player" id="media-player-wrap">';
  html += '<div class="player-title" id="player-title">No audio selected</div>';
  html += '<audio id="audio-player" controls preload="metadata" style="display:none"></audio>';
  html += '</div>';

  /* Reader */
  html += '<div class="media-reader"><div id="chapter-content" class="chapter-prose"></div></div>';

  el.innerHTML = html;

  if (chapters.length) selectChapter(0);
}

function selectChapter(idx) {
  const chapters = DATA.chapters || [];
  const ch = chapters[idx];
  if (!ch) return;
  currentChapter = idx;

  /* Update active state */
  document.querySelectorAll('.chapter-item').forEach(ci => ci.classList.remove('active'));
  const btn = document.querySelector('.chapter-item[data-idx="' + idx + '"]');
  if (btn) btn.classList.add('active');

  /* Update reader */
  document.getElementById('chapter-content').innerHTML = md2html(ch.content);

  /* Update audio player */
  const audiobooks = DATA.audiobooks || [];
  const audioMap = {};
  audiobooks.forEach(ab => { audioMap[ab.chapter] = ab; });
  const audio = audioMap[ch.number];
  const player = document.getElementById('audio-player');
  const title = document.getElementById('player-title');

  if (audio) {
    title.textContent = 'Ch ' + ch.number + ': ' + ch.title;
    player.src = audio.file;
    player.style.display = 'block';
  } else {
    title.textContent = 'No audio for this chapter';
    player.style.display = 'none';
    player.src = '';
  }
}

/* ==================== Init ==================== */
renderHeader();
renderSidebar();
renderPlayer();
renderGM();
renderCampaign();
renderMedia();

/* Set initial view from DATA */
const initView = DATA.dashboard_type || 'player';
if (initView !== 'player') switchView(initView);
</script>
</body>
</html>
